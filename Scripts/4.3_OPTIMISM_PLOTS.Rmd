---
title: "Optimism Plots"
output: html_document
---

### Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#checks for installation and loads packages
pacman::p_load(lmerTest,ggThemeAssist,rptR,lme4,readxl, tidyr, dplyr, magrittr, lubridate, stringr, purrr,
               sjPlot,ggplot2,lubridate,wesanderson,ggbeeswarm,emmeans,patchwork,viridis,nlme,Rmisc,ggpubr,
               stargazer)
# Load custom functions
source("../Scripts/functions_plots.R") #load custom functions
```

#Creating tibbles to use in plotting repeatabilities : one for overall plots, and one for sex plots

Positive analysis
```{r, echo=FALSE}
Positive_rptr_F0 <- tibble(
  Group = c("Control", "Treatment", "Contrast", "Between-Individual Variance (Control Group)", "Within-Individual Variance (Control Group)","Between-Individual Variance (Treatment Group)", "Within-Individual Variance (Treatment Group)"),
  r = c(rpt_positive_control$R$Fish_ID,rpt_positive_treatment$R$Fish_ID, m_positive, within_between_positive_control$R[1], within_between_positive_control$R[2],within_between_positive_treatment$R[1], within_between_positive_treatment$R[2]),
  ci.lb = c(rpt_positive_control$CI_emp$`2.5%`,rpt_positive_treatment$CI_emp$`2.5%`,-0.07, within_between_positive_control$CI_emp[1,1], within_between_positive_control$CI_emp[2,1],within_between_positive_treatment$CI_emp[1,1], within_between_positive_treatment$CI_emp[2,1]),
  ci.ub = c(rpt_positive_control$CI_emp$`97.5%`,rpt_positive_treatment$CI_emp$`97.5%`, 0.30, within_between_positive_control$CI_emp[1,2], within_between_positive_control$CI_emp[2,2],within_between_positive_treatment$CI_emp[1,2], within_between_positive_treatment$CI_emp[2,2]),
Endpoint = c("Positive", "Positive", "Positive", "Positive", "Positive","Positive","Positive"))
  
Positive_rptr_F0$r <- as.numeric(Positive_rptr_F0$r)
Positive_rptr_F0

Positive_rptr_sex <- tibble(
  Tank = c("Control","Control", "Treatment", "Treatment", "Control", "Treatment"),
  Condition = c("Male","Female","Male", "Female", "Contrast", "Contrast"),
  r = c(rpt_positive_control_male$R$Fish_ID,rpt_positive_control_female$R$Fish_ID,rpt_positive_treatment_male$R$Fish_ID,rpt_positive_treatment_female$R$Fish_ID,m_positive_control, m_positive_treatment ),
  ci.lb = c(rpt_positive_control_male$CI_emp$`2.5%`,rpt_positive_control_female$CI_emp$`2.5%`,rpt_positive_treatment_male$CI_emp$`2.5%`,rpt_positive_treatment_female$CI_emp$`2.5%`, -0.13, -0.23),
  ci.ub = c(rpt_positive_control_male$CI_emp$`97.5%`,rpt_positive_control_female$CI_emp$`97.5%`,rpt_positive_treatment_male$CI_emp$`97.5%`,rpt_positive_treatment_female$CI_emp$`97.5%`, 0.36, 0.28),
Endpoint = c("Positive","Positive","Positive","Positive","Positive","Positive"))
  
Positive_rptr_sex
```


Negative analysis
```{r, echo=FALSE}
Negative_rptr_F0 <- tibble(
  Group = c("Control", "Treatment", "Contrast", "Between-Individual Variance (Control Group)", "Within-Individual Variance (Control Group)","Between-Individual Variance (Treatment Group)", "Within-Individual Variance (Treatment Group)"),
  r = c(rpt_Negative_control$R$Fish_ID,rpt_Negative_treatment$R$Fish_ID, m_Negative, within_between_Negative_control$R[1], within_between_Negative_control$R[2],within_between_Negative_treatment$R[1], within_between_Negative_treatment$R[2]),
  ci.lb = c(rpt_Negative_control$CI_emp$`2.5%`,rpt_Negative_treatment$CI_emp$`2.5%`,-6.867212e-15, within_between_Negative_control$CI_emp[1,1], within_between_Negative_control$CI_emp[2,1],within_between_Negative_treatment$CI_emp[1,1], within_between_Negative_treatment$CI_emp[2,1]),
  ci.ub = c(rpt_Negative_control$CI_emp$`97.5%`,rpt_Negative_treatment$CI_emp$`97.5%`, 2.347739e-01, within_between_Negative_control$CI_emp[1,2], within_between_Negative_control$CI_emp[2,2],within_between_Negative_treatment$CI_emp[1,2], within_between_Negative_treatment$CI_emp[2,2]),
Endpoint = c("Negative", "Negative", "Negative", "Negative", "Negative","Negative","Negative"))
  
Negative_rptr_F0$r <- as.numeric(Negative_rptr_F0$r)
Negative_rptr_F0

Negative_rptr_sex <- tibble(
  Tank = c("Control","Control", "Treatment", "Treatment", "Control", "Treatment"),
  Condition = c("Male","Female","Male", "Female", "Contrast", "Contrast"),
  r = c(rpt_negative_control_male$R$Fish_ID,rpt_negative_control_female$R$Fish_ID,rpt_negative_treatment_male$R$Fish_ID,rpt_negative_treatment_female$R$Fish_ID,m_negative_control, m_negative_treatment ),
  ci.lb = c(rpt_negative_control_male$CI_emp$`2.5%`,rpt_negative_control_female$CI_emp$`2.5%`,rpt_negative_treatment_male$CI_emp$`2.5%`,rpt_negative_treatment_female$CI_emp$`2.5%`, -0.16, -0.23),
  ci.ub = c(rpt_negative_control_male$CI_emp$`97.5%`,rpt_negative_control_female$CI_emp$`97.5%`,rpt_negative_treatment_male$CI_emp$`97.5%`,rpt_negative_treatment_female$CI_emp$`97.5%`, 0.23, 0.12),
Endpoint = c("Negative","Negative","Negative","Negative","Negative","Negative"))
  
Negative_rptr_sex
```


Mixed analysis
```{r, echo=FALSE}
Mixed_rptr_F0 <- tibble(
  Group = c("Control", "Treatment", "Contrast", "Between-Individual Variance (Control Group)", "Within-Individual Variance (Control Group)","Between-Individual Variance (Treatment Group)", "Within-Individual Variance (Treatment Group)"),
  r = c(rpt_Mixed_control$R$Fish_ID,rpt_Mixed_treatment$R$Fish_ID, m_Mixed, within_between_Mixed_control$R[1], within_between_Mixed_control$R[2],within_between_Mixed_treatment$R[1], within_between_Mixed_treatment$R[2]),
  ci.lb = c(rpt_Mixed_control$CI_emp$`2.5%`,rpt_Mixed_treatment$CI_emp$`2.5%`,-0.14, within_between_Mixed_control$CI_emp[1,1], within_between_Mixed_control$CI_emp[2,1],within_between_Mixed_treatment$CI_emp[1,1], within_between_Mixed_treatment$CI_emp[2,1]),
  ci.ub = c(rpt_Mixed_control$CI_emp$`97.5%`,rpt_Mixed_treatment$CI_emp$`97.5%`, 0.24, within_between_Mixed_control$CI_emp[1,2], within_between_Mixed_control$CI_emp[2,2],within_between_Mixed_treatment$CI_emp[1,2], within_between_Mixed_treatment$CI_emp[2,2]),
Endpoint = c("Mixed", "Mixed", "Mixed", "Mixed", "Mixed","Mixed","Mixed"))
  
Mixed_rptr_F0$r <- as.numeric(Mixed_rptr_F0$r)
Mixed_rptr_F0

Mixed_rptr_sex <- tibble(
  Tank = c("Control","Control", "Treatment", "Treatment", "Control", "Treatment"),
  Condition = c("Male","Female","Male", "Female", "Contrast", "Contrast"),
  r = c(rpt_mixed_control_male$R$Fish_ID,rpt_mixed_control_female$R$Fish_ID,rpt_mixed_treatment_male$R$Fish_ID,rpt_mixed_treatment_female$R$Fish_ID,m_mixed_control, m_mixed_treatment ),
  ci.lb = c(rpt_mixed_control_male$CI_emp$`2.5%`,rpt_mixed_control_female$CI_emp$`2.5%`,rpt_mixed_treatment_male$CI_emp$`2.5%`,rpt_mixed_treatment_female$CI_emp$`2.5%`, -0.30, -0.23),
  ci.ub = c(rpt_mixed_control_male$CI_emp$`97.5%`,rpt_mixed_control_female$CI_emp$`97.5%`,rpt_mixed_treatment_male$CI_emp$`97.5%`,rpt_mixed_treatment_female$CI_emp$`97.5%`, 0.28, 0.30),
Endpoint = c("Mixed","Mixed","Mixed","Mixed","Mixed","Mixed"))
  
Mixed_rptr_sex
```

Joining tibbles to use in plotting 
```{r}

#Joining all tibbles for overall
Optimism_Joined1 <- full_join(Positive_rptr_F0, Negative_rptr_F0)
Optimism_Joined_Final <- full_join(Optimism_Joined1, Mixed_rptr_F0)



Overall_Optimism_Plotting_Data_F0 <- subset(Optimism_Joined_Final, Optimism_Joined_Final$Group %in% c("Treatment","Control","Contrast")) #Will be used for plotting just the overall repeatabilites 



#Joining all tibbles for sex
Overall_Optimism_Sex1 <- full_join(Positive_rptr_sex, Negative_rptr_sex)
Overall_Optimism_Sex_Final <- full_join(Overall_Optimism_Sex1, Mixed_rptr_sex)
Overall_Optimism_Sex_Final


```

#Overall forest plot showing repeatabilities of control and treatment groups (Optimism F0)
```{r}

Overall_plot_F0_optimism <- ggplot(Overall_Optimism_Plotting_Data_F0, aes(x=Endpoint, y=r, colour=Group)) +
geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0.4, position = position_dodge(0.3), size=0.8) +
geom_point(aes(x = Endpoint, y = r), position = position_dodge(0.3), size=3)+
geom_hline(yintercept = 0, lty = "dotted") +
coord_flip()+
ylim(-0.25, 0.9)+
   theme(axis.title.y=element_blank())+
  theme_classic()+
  scale_color_manual(values=c("#000000", "#DD8D29", "#E2D200"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=2),axis.ticks = element_line(size=2,color="black"),axis.ticks.length=unit(0.2,"cm"))+      font("xylab",size=15)+font("xy",size=15)+font("xy.text", size = 15) +
  theme(axis.title.y=element_blank())+
   theme(legend.position = "bottom")+
    theme(legend.title=element_blank())
 


Overall_plot_F0_optimism
```

#Overall forest plot showing differences between males and female repeatabilities for optimism 
```{r}
Sex_New_plot_optimism <-
  ggplot(Overall_Optimism_Sex_Final,
         aes(x = Endpoint, y = r, colour = Condition)) +
  geom_errorbar(
    aes(ymin = ci.lb, ymax = ci.ub),
    width = 0.4,
    position = position_dodge(0.3),
    size = 0.8
  ) +
  geom_point(aes(x = Endpoint, y = r),
             position = position_dodge(0.3),
             size = 3) +
  geom_hline(yintercept = 0, lty = "dotted") +
  coord_flip() +
  ylim(-0.4, 0.9) +
  facet_grid( ~ Tank) +
  theme(axis.title.y = element_blank()) +
  scale_color_manual(values = c("#000000", "#f8766d", "#00bfc4")) +
    theme_classic()+
  theme(
    panel.border = element_rect(
      colour = "black",
      fill = NA,
      size = 2
    ),
    axis.ticks = element_line(size = 2, color = "black"),
    axis.ticks.length = unit(0.2, "cm")
  ) +      font("xylab", size = 15) + font("xy", size = 15) + font("xy.text", size = 15) +
  theme(axis.title.y = element_blank()) +
  theme(legend.position = "bottom") +
  theme(legend.title = element_blank())

Sex_New_plot_optimism

```


#Generating custom designed violin plots to display raw distributions of behavioral responses
```{r}


positive_violin <- violin_plot_custom_hamza2(Positive_ALL,Positive_ALL$zone_05_dur,"Time spent near positive stimulus", "Seconds")


negative_violin <- violin_plot_custom_hamza2(Negative_ALL, Negative_ALL$zone_05_dur, "Time spent near negative stimulus", "Seconds")



mixed_violin <- violin_plot_custom_hamza2(Mixed_ALL, Mixed_ALL$zone_05_dur, "Time spent near mixed stimulus", "Seconds")



#Joining plots together using patchwork to create one main plot

Joined_violins_optimism <- positive_violin + negative_violin + mixed_violin + plot_layout(ncol = 2, nrow=2)
Joined_violins_optimism
```

Table to display mixed model results (using stargazer)
```{r}
stargazer(Model_Positive1, Model_Negative1, Model_Mixed1, omit.stat = c("bic","aic","ll"),  covariate.labels = c("Control", "Treatment", "Male", "Treatment:Male"), align = TRUE, type= "html",dep.var.labels= c("Positive      Negative      Mixed"),dep.var.caption= "Stimuli",style="all", out = "Table.html")
```
