---
title: "Personality"
author: "Hamza"
date: "12/02/2020"
output:
  html_document: default
  pdf_document: default
---


### Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#checks for installation and loads packages
pacman::p_load(lmerTest,ggThemeAssist,rptR,lme4,readxl, tidyr, dplyr, magrittr, lubridate, stringr, purrr,
               sjPlot,ggplot2,lubridate,wesanderson,ggbeeswarm,emmeans,patchwork,viridis,nlme,Rmisc,ggpubr,
               stargazer)

# Load custom function to extract data 
source("../Scripts/functions_repeatability.R")
source("../Scripts/functions_personality.R")

```

### Import and subset data

First, we select a stimulus, which we want all the data for. Then with the function, we filter which videos have that stimulus in the first, second, third and fourth phase (via the time). Then we join all to create one dataset of that stimulus.
```{r}
Personality <- read.csv("../Data/Personality/ALL.csv")



#Gathering all Social Data 

filter_etho(Personality, c("A","C","D","E","G","M"), ("6-9")) -> Social_Phase_1
filter_etho(Personality, c("J","K","L","P","U","X"), ("13-16")) -> Social_Phase_2
filter_etho(Personality, c("H","I","R","S","T","W"), ("20-23")) -> Social_Phase_3
filter_etho(Personality, c("B","F","N","O","Q","V"), ("27-30")) -> Social_Phase_4

Social_ALL <- bind_rows(Social_Phase_1,Social_Phase_2, Social_Phase_3, Social_Phase_4)



#Gathering all Predator Data

filter_etho(Personality, c("F","K","O","T","W","X"), ("6-9")) -> Predator_Phase_1
filter_etho(Personality, c("E","G","N","Q","R","S"), ("13-16")) -> Predator_Phase_2
filter_etho(Personality, c("B","C","M","P","U","V"), ("20-23")) -> Predator_Phase_3
filter_etho(Personality, c("A","D","H","I","J","L"), ("27-30")) -> Predator_Phase_4

Predator_ALL <- bind_rows(Predator_Phase_1,Predator_Phase_2, Predator_Phase_3, Predator_Phase_4)





#Gathering all Novel Data


filter_etho(Personality, c("B","H","J","N","P","R"), ("6-9")) -> Novel_Phase_1
filter_etho(Personality, c("A","I","M","O","V","W"), ("13-16")) -> Novel_Phase_2
filter_etho(Personality, c("D","F","G","L","Q","X"), ("20-23")) -> Novel_Phase_3
filter_etho(Personality, c("C","E","K","S","T","U"), ("27-30")) -> Novel_Phase_4

Novel_ALL <- bind_rows(Novel_Phase_1,Novel_Phase_2, Novel_Phase_3, Novel_Phase_4)





#Gathering all Aggression Data


filter_etho(Personality, c("I","L","Q","S","U","V"), ("6-9")) -> Aggression_Phase_1
filter_etho(Personality, c("B","C","D","F","H","T"), ("13-16")) -> Aggression_Phase_2
filter_etho(Personality, c("A","E","J","K","N","O"), ("20-23")) -> Aggression_Phase_3
filter_etho(Personality, c("G","M","P","R","W","X"), ("27-30")) -> Aggression_Phase_4

Aggression_ALL <- bind_rows(Aggression_Phase_2,Aggression_Phase_2, Aggression_Phase_3, Aggression_Phase_4)

#Subsetting data by control and treatment
Social_Control <- subset(Social_ALL, Social_ALL$Group == "Control") 
Social_Treatment <- subset(Social_ALL, Social_ALL$Group == "Treatment") 

Predator_Control <- subset(Predator_ALL, Predator_ALL$Group == "Control") 
Predator_Treatment <- subset(Predator_ALL, Predator_ALL$Group == "Treatment") 

Novel_Control <- subset(Novel_ALL, Novel_ALL$Group == "Control") 
Novel_Treatment <- subset(Novel_ALL, Novel_ALL$Group == "Treatment") 

Aggression_Control <- subset(Aggression_ALL, Aggression_ALL$Group == "Control") 
Aggression_Treatment <- subset(Aggression_ALL, Aggression_ALL$Group == "Treatment") 

# EXPLORATION DATA
Acclimation <- read.csv("../Data/Personality/Acclimation.csv")
Post_assay <- read.csv("../Data/Personality/Post-assay.csv")

```

### MAIN ANALYSIS 
1) CHECKING NORMALITY ASSUMPTIONS WITH MIXED MODELS AND A HISTOGRAM OF RESIDUALS
2) PERFORMING REPEATABILITY ANALYSIS FOR EACH GROUP AND EXTRACTING WITHIN-AND BETWEEN-INDIVIDUAL VARIANCES AFTER A Z TRANSFORMATION
3) CALCULATING DIFFERENCES BETWEEN REPEATABILITIES
4) FINAL MIXED MODEL USING LME FUNCTION
5) CALCULATING VARIANCE DIFFERENCES BETWEEN CONTROL AND TREATMENT

Exploration (Acclimation and post-stimulus)

```{r}
Model_acclimation <- lmer(dist.center.point.Total.cm ~ Group + Sex + (1 | ID), data = Acclimation) 
tab_model(Model_acclimation)
hist(residuals(Model_acclimation)) 

#Quick Visualization
Acclimation %>%
  ggplot(aes(Group, dist.center.point.Total.cm, fill=Group)) +
  geom_violin(
    trim = FALSE,
    draw_quantiles = c(0.25, 0.5, 0.75), 
    alpha=0.5
  ) + 
  geom_point(position = "jitter", alpha = 0.7, size = 3)+
  facet_grid(~Sex)

Model_post <- lmer(dist.center.point.Total.cm ~ Group + Sex + (1 | ID), data = Post_assay) 
tab_model(Model_post)
hist(residuals(Model_post)) 

#Quick Visualization
Post_assay %>%
  ggplot(aes(Group, dist.center.point.Total.cm, fill=Group)) +
  geom_violin(
    trim = FALSE,
    draw_quantiles = c(0.25, 0.5, 0.75), 
    alpha=0.5
  ) + 
  geom_point(position = "jitter", alpha = 0.7, size = 3)+
  facet_grid(~Sex)
```


Social Analysis - time spent near stimulus screen 
```{r}
#Check Normality with mixed model and then histogram of residuals

Model_Social_zone05 <- lmer(zone_05_dur ~ Group + Sex + (1 | Fish_ID), data = Social_ALL) 
tab_model(Model_Social_zone05)
hist(residuals(Model_Social_zone05)) 

Model_Social_zone052 <- lmer(zone_05_dur ~ Group*Sex + (1 | Fish_ID), data = Social_ALL) 
tab_model(Model_Social_zone052)
hist(residuals(Model_Social_zone052)) 

#Calculating repeatabilities using custom made functions
rpt_zone05(Social_Control) -> rpt_social_control
rpt_social_control
rpt_zone05(Social_Treatment) -> rpt_social_treatment
rpt_social_treatment

#Obtaining within-individual and between-individual variance 

rpt_within_zone05(Social_Control) -> within_between_social_control
within_between_social_control
rpt_within_zone05(Social_Treatment) -> within_between_social_treatment
within_between_social_treatment

#Obtaining differences between repeatabilities using custom made functions
Control_social_boot <- unlist_rptr(rpt_social_control)
Treatment_social_boot <- unlist_rptr(rpt_social_treatment) 
social_diff <- difference_boot(Treatment_social_boot,Control_social_boot)  
q_social <- quantiles_diff_boot(social_diff) #obtaining 95% CI
m_social <- mean(social_diff) #Obtaining mean
m_social
q_social

# Calculating difference in variance between control and treatment groups
Model_Social1 <- lme(zone_05_dur ~ Group*Sex-1, random = ~ 1| Fish_ID, data = Social_ALL, na.action=na.exclude) #mixed model without variance structure
summary(Model_Social1)
Model_Social2 <- lme(zone_05_dur ~ Group*Sex-1, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Group), data = Social_ALL, na.action=na.exclude) #mixed model with variance structure varIdent
summary(Model_Social2)
anova(Model_Social1, Model_Social2) #calculating difference between two models to find difference in variance

#Quick Visualization
Social_ALL %>%
  ggplot(aes(Group, zone_05_dur, fill=Group)) +
  geom_violin(
    trim = FALSE,
    draw_quantiles = c(0.25, 0.5, 0.75), 
    alpha=0.5
  ) + 
  geom_point(position = "jitter", alpha = 0.7, size = 3)
```

Social Analysis - mean speed
```{r}
#Check Normality with mixed model and then histogram of residuals

Model_Social_speed <- lmer(mean_speed ~ Group + Sex + (1 | Fish_ID), data = Social_ALL) 
tab_model(Model_Social_speed)
hist(residuals(Model_Social_speed)) 


#Calculating repeatabilities using custom made functions
rpt_speed(Social_Control) -> rpt_social_control_speed
rpt_social_control_speed
rpt_speed(Social_Treatment) -> rpt_social_treatment_speed
rpt_social_treatment_speed

#Obtaining within-individual and between-individual variance 

rpt_within_speed(Social_Control) -> within_between_social_control_speed
within_between_social_control_speed
rpt_within_speed(Social_Treatment) -> within_between_social_treatment_speed
within_between_social_treatment_speed

#Obtaining differences between repeatabilities using custom made functions
Control_social_boot_speed <- unlist_rptr(rpt_social_control_speed)
Treatment_social_boot_speed <- unlist_rptr(rpt_social_treatment_speed) 
social_diff_speed <- difference_boot(Treatment_social_boot_speed,Control_social_boot_speed)  
q_social_speed <- quantiles_diff_boot(social_diff_speed) #obtaining 95% CI
m_social_speed <- mean(social_diff_speed) #Obtaining mean
m_social_speed
q_social_speed

# Calculating difference in variance between control and treatment groups
Model_Social1_speed <- lme(mean_speed ~ Group-1 + Sex, random = ~ 1| Fish_ID, data = Social_ALL, na.action=na.exclude) #mixed model without variance structure
summary(Model_Social1_speed)
Model_Social2_speed <- lme(mean_speed ~ Group-1 + Sex, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Group), data = Social_ALL, na.action=na.exclude) #mixed model with variance structure varIdent
summary(Model_Social2_speed)
anova(Model_Social1_speed, Model_Social2_speed) #calculating difference between two models to find difference in variance

#Quick Visualization
Social_ALL %>%
  ggplot(aes(Group, mean_speed, fill=Group)) +
  geom_violin(
    trim = FALSE,
    draw_quantiles = c(0.25, 0.5, 0.75), 
    alpha=0.5
  ) + 
  geom_point(position = "jitter", alpha = 0.7, size = 3)
```

Social Analysis - total distance

```{r}
#Check Normality with mixed model and then histogram of residuals

Model_Social_tot_dist <- lmer(tot_dist ~ Group + Sex + (1 | Fish_ID), data = Social_ALL) 
tab_model(Model_Social_tot_dist)
hist(residuals(Model_Social_tot_dist)) 

Model_Social_tot_dist2 <- lmer(tot_dist ~ Group*Sex + (1 | Fish_ID), data = Social_ALL) 
tab_model(Model_Social_tot_dist2)
hist(residuals(Model_Social_tot_dist2)) 

#Calculating repeatabilities using custom made functions
rpt_tot_dist(Social_Control) -> rpt_social_control_dist
rpt_social_control_dist
rpt_tot_dist(Social_Treatment) -> rpt_social_treatment_dist
rpt_social_treatment_dist

#Obtaining within-individual and between-individual variance 

rpt_within_tot_dist(Social_Control) -> within_between_social_control_dist
within_between_social_control_dist
rpt_within_tot_dist(Social_Treatment) -> within_between_social_treatment_dist
within_between_social_treatment_dist

#Obtaining differences between repeatabilities using custom made functions
Control_social_boot_dist <- unlist_rptr(rpt_social_control_dist)
Treatment_social_boot_dist <- unlist_rptr(rpt_social_treatment_dist) 
social_diff_dist <- difference_boot(Treatment_social_boot,Control_social_boot)  
q_social_dist <- quantiles_diff_boot(social_diff_dist) #obtaining 95% CI
m_social_dist <- mean(social_diff_dist) #Obtaining mean
m_social_dist
q_social_dist

# Calculating difference in variance between control and treatment groups
Model_Social1_dist <- lme(tot_dist ~ Group*Sex-1, random = ~ 1| Fish_ID, data = Social_ALL, na.action=na.exclude) #mixed model without variance structure
summary(Model_Social1_dist)
Model_Social2_dist <- lme(tot_dist ~ Group*Sex-1, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Group), data = Social_ALL, na.action=na.exclude) #mixed model with variance structure varIdent
summary(Model_Social2_dist)
anova(Model_Social1_dist, Model_Social2_dist) #calculating difference between two models to find difference in variance

#Quick Visualization
Social_ALL %>%
  ggplot(aes(Group, tot_dist, fill=Group)) +
  geom_violin(
    trim = FALSE,
    draw_quantiles = c(0.25, 0.5, 0.75), 
    alpha=0.5
  ) + 
  geom_point(position = "jitter", alpha = 0.7, size = 3)
```


Predator Analysis - time spent near stimulus screen 
```{r}
#Check Normality with mixed model and then histogram of residuals

Model_Predator_zone05 <- lmer(zone_05_dur ~ Group + Sex + (1 | Fish_ID), data = Predator_ALL) 
tab_model(Model_Predator_zone05)
hist(residuals(Model_Predator_zone05)) 


#Calculating repeatabilities using custom made functions
rpt_zone05(Predator_Control) -> rpt_predator_control
rpt_predator_control
rpt_zone05(Predator_Treatment) -> rpt_predator_treatment
rpt_predator_treatment

#Obtaining within-individual and between-individual variance 

rpt_within_zone05(Predator_Control) -> within_between_predator_control
within_between_predator_control
rpt_within_zone05(Predator_Treatment) -> within_between_predator_treatment
within_between_predator_treatment

#Obtaining differences between repeatabilities using custom made functions
Control_predator_boot <- unlist_rptr(rpt_predator_control)
Treatment_predator_boot <- unlist_rptr(rpt_predator_treatment) 
predator_diff <- difference_boot(Treatment_predator_boot,Control_predator_boot)  
q_predator <- quantiles_diff_boot(predator_diff) #obtaining 95% CI
m_predator <- mean(positive_diff) #Obtaining mean
m_predator
q_predator

# Calculating difference in variance between control and treatment groups
Model_Predator1 <- lme(zone_05_dur ~ Group-1 + Sex, random = ~ 1| Fish_ID, data = Predator_ALL, na.action=na.exclude) #mixed model without variance structure
summary(Model_Predator1)
Model_Predator2 <- lme(zone_05_dur ~ Group-1 + Sex, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Group), data = Predator_ALL, na.action=na.exclude) #mixed model with variance structure varIdent
summary(Model_Predator2)
anova(Model_Predator1, Model_Predator2) #calculating difference between two models to find difference in variance

#Quick Visualization
Predator_ALL %>%
  ggplot(aes(Group, zone_05_dur, fill=Group)) +
  geom_violin(
    trim = FALSE,
    draw_quantiles = c(0.25, 0.5, 0.75), 
    alpha=0.5
  ) + 
  geom_point(position = "jitter", alpha = 0.7, size = 3)
```

Predator Analysis - mean speed
```{r}
#Check Normality with mixed model and then histogram of residuals

Model_Predator_speed <- lmer(mean_speed ~ Group + Sex + (1 | Fish_ID), data = Predator_ALL) 
tab_model(Model_Predator_speed)
hist(residuals(Model_Predator_speed)) 


#Calculating repeatabilities using custom made functions
rpt_speed(Predator_Control) -> rpt_predator_control_speed
rpt_predator_control_speed
rpt_speed(Predator_Treatment) -> rpt_predator_treatment_speed
rpt_predator_treatment_speed

#Obtaining within-individual and between-individual variance 

rpt_within_speed(Predator_Control) -> within_between_predator_control_speed
within_between_predator_control_speed
rpt_within_speed(Predator_Treatment) -> within_between_predator_treatment_speed
within_between_predator_treatment_speed

#Obtaining differences between repeatabilities using custom made functions
Control_predator_boot_speed <- unlist_rptr(rpt_predator_control_speed)
Treatment_predator_boot_speed <- unlist_rptr(rpt_predator_treatment_speed) 
predator_diff_speed <- difference_boot(Treatment_predator_boot_speed,Control_predator_boot_speed)  
q_predator_speed <- quantiles_diff_boot(predator_diff_speed) #obtaining 95% CI
m_predator_speed <- mean(predator_diff_speed) #Obtaining mean
m_predator_speed
q_predator_speed

# Calculating difference in variance between control and treatment groups
Model_Predator1_speed <- lme(mean_speed ~ Group-1 + Sex, random = ~ 1| Fish_ID, data = Predator_ALL, na.action=na.exclude) #mixed model without variance structure
summary(Model_Predator1_speed)
Model_Predator2_speed <- lme(mean_speed ~ Group-1 + Sex, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Group), data = Predator_ALL, na.action=na.exclude) #mixed model with variance structure varIdent
summary(Model_Predator2_speed)
anova(Model_Predator1_speed, Model_Predator2_speed) #calculating difference between two models to find difference in variance

#Quick Visualization
Predator_ALL %>%
  ggplot(aes(Group, mean_speed, fill=Group)) +
  geom_violin(
    trim = FALSE,
    draw_quantiles = c(0.25, 0.5, 0.75), 
    alpha=0.5
  ) + 
  geom_point(position = "jitter", alpha = 0.7, size = 3)
```

Predator Analysis - total distance

```{r}
#Check Normality with mixed model and then histogram of residuals

Model_Predator_tot_dist <- lmer(tot_dist ~ Group + Sex + (1 | Fish_ID), data = Predator_ALL) 
tab_model(Model_Predator_tot_dist)
hist(residuals(Model_Predator_tot_dist)) 

Model_Predator_tot_dist2 <- lmer(tot_dist ~ Group*Sex + (1 | Fish_ID), data = Predator_ALL) 
tab_model(Model_Predator_tot_dist2)
hist(residuals(Model_Predator_tot_dist2)) 

#Calculating repeatabilities using custom made functions
rpt_tot_dist(Predator_Control) -> rpt_predator_control_dist
rpt_predator_control_dist
rpt_tot_dist(Predator_Treatment) -> rpt_predator_treatment_dist
rpt_predator_treatment_dist

#Obtaining within-individual and between-individual variance 

rpt_within_tot_dist(Predator_Control) -> within_between_predator_control_dist
within_between_predator_control_dist
rpt_within_tot_dist(Predator_Treatment) -> within_between_predator_treatment_dist
within_between_predator_treatment_dist

#Obtaining differences between repeatabilities using custom made functions
Control_predator_boot_dist <- unlist_rptr(rpt_predator_control_dist)
Treatment_predator_boot_dist <- unlist_rptr(rpt_predator_treatment_dist) 
predator_diff_dist <- difference_boot(Treatment_predator_boot,Control_predator_boot)  
q_predator_dist <- quantiles_diff_boot(predator_diff_dist) #obtaining 95% CI
m_predator_dist <- mean(predator_diff_dist) #Obtaining mean
m_predator_dist
q_predator_dist

# Calculating difference in variance between control and treatment groups
Model_Predator1_dist <- lme(tot_dist ~ Group*Sex-1, random = ~ 1| Fish_ID, data = Predator_ALL, na.action=na.exclude) #mixed model without variance structure
summary(Model_Predator1_dist)
Model_Predator2_dist <- lme(tot_dist ~ Group*Sex-1, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Group), data = Predator_ALL, na.action=na.exclude) #mixed model with variance structure varIdent
summary(Model_Predator2_dist)
anova(Model_Predator1_dist, Model_Predator2_dist) #calculating difference between two models to find difference in variance

#Quick Visualization
Predator_ALL %>%
  ggplot(aes(Group, tot_dist, fill=Group)) +
  geom_violin(
    trim = FALSE,
    draw_quantiles = c(0.25, 0.5, 0.75), 
    alpha=0.5
  ) + 
  geom_point(position = "jitter", alpha = 0.7, size = 3)
```


Novel Analysis - time spent near stimulus screen 
```{r}
#Check Normality with mixed model and then histogram of residuals

Model_Novel_zone05 <- lmer(zone_05_dur ~ Group + Sex + (1 | Fish_ID), data = Novel_ALL) 
tab_model(Model_Novel_zone05)
hist(residuals(Model_Novel_zone05)) #data skewed, needs transformation

Model_Novel_zone052 <- lmer(sqrt(zone_05_dur) ~ Group + Sex + (1 | Fish_ID), data = Novel_ALL) 
tab_model(Model_Novel_zone052)
hist(residuals(Model_Novel_zone052))


#Calculating repeatabilities using custom made functions
rpt_zone05(Novel_Control) -> rpt_novel_control
rpt_novel_control
rpt_zone05(Novel_Treatment) -> rpt_novel_treatment
rpt_novel_treatment

#Obtaining within-individual and between-individual variance 

rpt_within_zone05(Novel_Control) -> within_between_novel_control
within_between_novel_control
rpt_within_zone05(Novel_Treatment) -> within_between_novel_treatment
within_between_novel_treatment

#Obtaining differences between repeatabilities using custom made functions
Control_novel_boot <- unlist_rptr(rpt_novel_control)
Treatment_novel_boot <- unlist_rptr(rpt_novel_treatment) 
novel_diff <- difference_boot(Control_novel_boot,Treatment_novel_boot)  
q_novel <- quantiles_diff_boot(novel_diff) #obtaining 95% CI
m_novel <- mean(novel_diff) #Obtaining mean
m_novel
q_novel

# Calculating difference in variance between control and treatment groups
Model_Novel1 <- lme(sqrt(zone_05_dur) ~ Group-1 + Sex, random = ~ 1| Fish_ID, data = Novel_ALL, na.action=na.exclude) #mixed model without variance structure
summary(Model_Novel1)
Model_Novel2 <- lme(sqrt(zone_05_dur) ~ Group-1 + Sex, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Group), data = Novel_ALL, na.action=na.exclude) #mixed model with variance structure varIdent
summary(Model_Novel2)
anova(Model_Novel1, Model_Novel2) #calculating difference between two models to find difference in variance

#Quick Visualization
Novel_ALL %>%
  ggplot(aes(Group, zone_05_dur, fill=Group)) +
  geom_violin(
    trim = FALSE,
    draw_quantiles = c(0.25, 0.5, 0.75), 
    alpha=0.5
  ) + 
  geom_point(position = "jitter", alpha = 0.7, size = 3)
```

Novel Analysis - mean speed
```{r}
#Check Normality with mixed model and then histogram of residuals

Model_Novel_speed <- lmer(mean_speed ~ Group + Sex + (1 | Fish_ID), data = Novel_ALL) 
tab_model(Model_Novel_speed)
hist(residuals(Model_Novel_speed)) 


#Calculating repeatabilities using custom made functions
rpt_speed(Novel_Control) -> rpt_novel_control_speed
rpt_novel_control_speed
rpt_speed(Novel_Treatment) -> rpt_novel_treatment_speed
rpt_novel_treatment_speed

#Obtaining within-individual and between-individual variance 

rpt_within_speed(Novel_Control) -> within_between_novel_control_speed
within_between_novel_control_speed
rpt_within_speed(Novel_Treatment) -> within_between_novel_treatment_speed
within_between_novel_treatment_speed

#Obtaining differences between repeatabilities using custom made functions
Control_novel_boot_speed <- unlist_rptr(rpt_novel_control_speed)
Treatment_novel_boot_speed <- unlist_rptr(rpt_novel_treatment_speed) 
novel_diff_speed <- difference_boot(Control_novel_boot_speed,Treatment_novel_boot_speed)  
q_novel_speed <- quantiles_diff_boot(novel_diff_speed) #obtaining 95% CI
m_novel_speed <- mean(novel_diff_speed) #Obtaining mean
m_novel_speed
q_novel_speed

# Calculating difference in variance between control and treatment groups
Model_Novel1_speed <- lme(mean_speed ~ Group-1 + Sex, random = ~ 1| Fish_ID, data = Novel_ALL, na.action=na.exclude) #mixed model without variance structure
summary(Model_Novel1_speed)
Model_Novel2_speed <- lme(mean_speed ~ Group-1 + Sex, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Group), data = Novel_ALL, na.action=na.exclude) #mixed model with variance structure varIdent
summary(Model_Novel2_speed)
anova(Model_Novel1_speed, Model_Novel2_speed) #calculating difference between two models to find difference in variance

#Quick Visualization
Novel_ALL %>%
  ggplot(aes(Group, mean_speed, fill=Group)) +
  geom_violin(
    trim = FALSE,
    draw_quantiles = c(0.25, 0.5, 0.75), 
    alpha=0.5
  ) + 
  geom_point(position = "jitter", alpha = 0.7, size = 3)
```

Novel Analysis - total distance

```{r}
#Check Normality with mixed model and then histogram of residuals

Model_Novel_tot_dist <- lmer(tot_dist ~ Group + Sex + (1 | Fish_ID), data = Novel_ALL) 
tab_model(Model_Novel_tot_dist)
hist(residuals(Model_Novel_tot_dist)) 

Model_Novel_tot_dist2 <- lmer(tot_dist ~ Group*Sex + (1 | Fish_ID), data = Novel_ALL) 
tab_model(Model_Novel_tot_dist2)
hist(residuals(Model_Novel_tot_dist2)) 

#Calculating repeatabilities using custom made functions
rpt_tot_dist(Novel_Control) -> rpt_novel_control_dist
rpt_novel_control_dist
rpt_tot_dist(Novel_Treatment) -> rpt_novel_treatment_dist
rpt_novel_treatment_dist

#Obtaining within-individual and between-individual variance 

rpt_within_tot_dist(Novel_Control) -> within_between_novel_control_dist
within_between_novel_control_dist
rpt_within_tot_dist(Novel_Treatment) -> within_between_novel_treatment_dist
within_between_novel_treatment_dist

#Obtaining differences between repeatabilities using custom made functions
Control_novel_boot_dist <- unlist_rptr(rpt_novel_control_dist)
Treatment_novel_boot_dist <- unlist_rptr(rpt_novel_treatment_dist) 
novel_diff_dist <- difference_boot(Treatment_novel_boot,Control_novel_boot)  
q_novel_dist <- quantiles_diff_boot(novel_diff_dist) #obtaining 95% CI
m_novel_dist <- mean(novel_diff_dist) #Obtaining mean
m_novel_dist
q_novel_dist

# Calculating difference in variance between control and treatment groups
Model_Novel1_dist <- lme(tot_dist ~ Group*Sex-1, random = ~ 1| Fish_ID, data = Novel_ALL, na.action=na.exclude) #mixed model without variance structure
summary(Model_Novel1_dist)
Model_Novel2_dist <- lme(tot_dist ~ Group*Sex-1, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Group), data = Novel_ALL, na.action=na.exclude) #mixed model with variance structure varIdent
summary(Model_Novel2_dist)
anova(Model_Novel1_dist, Model_Novel2_dist) #calculating difference between two models to find difference in variance

#Quick Visualization
Novel_ALL %>%
  ggplot(aes(Group, tot_dist, fill=Group)) +
  geom_violin(
    trim = FALSE,
    draw_quantiles = c(0.25, 0.5, 0.75), 
    alpha=0.5
  ) + 
  geom_point(position = "jitter", alpha = 0.7, size = 3)
```

Aggression Analysis - time spent near stimulus screen 
```{r}
#Check Normality with mixed model and then histogram of residuals

Model_Aggression_zone05 <- lmer(zone_05_dur ~ Group + Sex + (1 | Fish_ID), data = Aggression_ALL) 
tab_model(Model_Aggression_zone05)
hist(residuals(Model_Aggression_zone05)) 


#Calculating repeatabilities using custom made functions
rpt_zone05(Aggression_Control) -> rpt_aggression_control
rpt_aggression_control
rpt_zone05(Aggression_Treatment) -> rpt_aggression_treatment
rpt_aggression_treatment

#Obtaining within-individual and between-individual variance 

rpt_within_zone05(Aggression_Control) -> within_between_aggression_control
within_between_aggression_control
rpt_within_zone05(Aggression_Treatment) -> within_between_aggression_treatment
within_between_aggression_treatment

#Obtaining differences between repeatabilities using custom made functions
Control_aggression_boot <- unlist_rptr(rpt_aggression_control)
Treatment_aggression_boot <- unlist_rptr(rpt_aggression_treatment) 
aggression_diff <- difference_boot(Treatment_aggression_boot,Control_aggression_boot)  
q_aggression <- quantiles_diff_boot(aggression_diff) #obtaining 95% CI
m_aggression <- mean(aggression_diff) #Obtaining mean
m_aggression
q_aggression

# Calculating difference in variance between control and treatment groups
Model_Aggression1 <- lme(zone_05_dur ~ Group-1 + Sex, random = ~ 1| Fish_ID, data = Aggression_ALL, na.action=na.exclude) #mixed model without variance structure
summary(Model_Aggression1)
Model_Aggression2 <- lme(zone_05_dur ~ Group-1 + Sex, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Group), data = Aggression_ALL, na.action=na.exclude) #mixed model with variance structure varIdent
summary(Model_Aggression2)
anova(Model_Aggression1, Model_Aggression2) #calculating difference between two models to find difference in variance

#Quick Visualization
Aggression_ALL %>%
  ggplot(aes(Group, zone_05_dur, fill=Group)) +
  geom_violin(
    trim = FALSE,
    draw_quantiles = c(0.25, 0.5, 0.75), 
    alpha=0.5
  ) + 
  geom_point(position = "jitter", alpha = 0.7, size = 3)
```

Aggression Analysis - mean speed
```{r}
#Check Normality with mixed model and then histogram of residuals

Model_Aggression_speed <- lmer(mean_speed ~ Group + Sex + (1 | Fish_ID), data = Aggression_ALL) 
tab_model(Model_Aggression_speed)
hist(residuals(Model_Aggression_speed)) 


#Calculating repeatabilities using custom made functions
rpt_speed(Aggression_Control) -> rpt_aggression_control_speed
rpt_aggression_control_speed
rpt_speed(Aggression_Treatment) -> rpt_aggression_treatment_speed
rpt_aggression_treatment_speed

#Obtaining within-individual and between-individual variance 

rpt_within_speed(Aggression_Control) -> within_between_aggression_control_speed
within_between_aggression_control_speed
rpt_within_speed(Aggression_Treatment) -> within_between_aggression_treatment_speed
within_between_aggression_treatment_speed

#Obtaining differences between repeatabilities using custom made functions
Control_aggression_boot_speed <- unlist_rptr(rpt_aggression_control_speed)
Treatment_aggression_boot_speed <- unlist_rptr(rpt_aggression_treatment_speed) 
aggression_diff_speed <- difference_boot(Control_aggression_boot_speed,Treatment_aggression_boot_speed)  
q_aggression_speed <- quantiles_diff_boot(aggression_diff_speed) #obtaining 95% CI
m_aggression_speed <- mean(aggression_diff_speed) #Obtaining mean
m_aggression_speed
q_aggression_speed

# Calculating difference in variance between control and treatment groups
Model_Aggression1_speed <- lme(mean_speed ~ Group-1 + Sex, random = ~ 1| Fish_ID, data = Aggression_ALL, na.action=na.exclude) #mixed model without variance structure
summary(Model_Aggression1_speed)
Model_Aggression2_speed <- lme(mean_speed ~ Group-1 + Sex, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Group), data = Aggression_ALL, na.action=na.exclude) #mixed model with variance structure varIdent
summary(Model_Aggression2_speed)
anova(Model_Aggression1_speed, Model_Aggression2_speed) #calculating difference between two models to find difference in variance

#Quick Visualization
Aggression_ALL %>%
  ggplot(aes(Group, mean_speed, fill=Group)) +
  geom_violin(
    trim = FALSE,
    draw_quantiles = c(0.25, 0.5, 0.75), 
    alpha=0.5
  ) + 
  geom_point(position = "jitter", alpha = 0.7, size = 3)
```

Aggression Analysis - total distance

```{r}
#Check Normality with mixed model and then histogram of residuals

Model_Aggression_tot_dist <- lmer(tot_dist ~ Group + Sex + (1 | Fish_ID), data = Aggression_ALL) 
tab_model(Model_Aggression_tot_dist)
hist(residuals(Model_Aggression_tot_dist)) 

Model_Aggression_tot_dist2 <- lmer(tot_dist ~ Group*Sex + (1 | Fish_ID), data = Aggression_ALL) 
tab_model(Model_Aggression_tot_dist2)
hist(residuals(Model_Aggression_tot_dist2)) 

#Calculating repeatabilities using custom made functions
rpt_tot_dist(Aggression_Control) -> rpt_aggression_control_dist
rpt_aggression_control_dist
rpt_tot_dist(Aggression_Treatment) -> rpt_aggression_treatment_dist
rpt_aggression_treatment_dist

#Obtaining within-individual and between-individual variance 

rpt_within_tot_dist(Aggression_Control) -> within_between_aggression_control_dist
within_between_aggression_control_dist
rpt_within_tot_dist(Aggression_Treatment) -> within_between_aggression_treatment_dist
within_between_aggression_treatment_dist

#Obtaining differences between repeatabilities using custom made functions
Control_aggression_boot_dist <- unlist_rptr(rpt_aggression_control_dist)
Treatment_aggression_boot_dist <- unlist_rptr(rpt_aggression_treatment_dist) 
aggression_diff_dist <- difference_boot(Treatment_aggression_boot,Control_aggression_boot)  
q_aggression_dist <- quantiles_diff_boot(aggression_diff_dist) #obtaining 95% CI
m_aggression_dist <- mean(aggression_diff_dist) #Obtaining mean
m_aggression_dist
q_aggression_dist

# Calculating difference in variance between control and treatment groups
Model_Aggression1_dist <- lme(tot_dist ~ Group*Sex-1, random = ~ 1| Fish_ID, data = Aggression_ALL, na.action=na.exclude) #mixed model without variance structure
summary(Model_Aggression1_dist)
Model_Aggression2_dist <- lme(tot_dist ~ Group*Sex-1, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Group), data = Aggression_ALL, na.action=na.exclude) #mixed model with variance structure varIdent
summary(Model_Aggression2_dist)
anova(Model_Aggression1_dist, Model_Aggression2_dist) #calculating difference between two models to find difference in variance

#Quick Visualization
Aggression_ALL %>%
  ggplot(aes(Group, tot_dist, fill=Group)) +
  geom_violin(
    trim = FALSE,
    draw_quantiles = c(0.25, 0.5, 0.75), 
    alpha=0.5
  ) + 
  geom_point(position = "jitter", alpha = 0.7, size = 3)
```




