---
title: "Personality"
author: "Hamza"
date: "12/02/2020"
output:
  html_document: default
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

### Load packages

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#checks for installation and loads packages
pacman::p_load(dplyr, brms, stringr, ggplot2, ggpubr)

```

### Converting from wide to long data format

```{r}
Personality <- read.csv("./Data/Personality/ALL.csv")
Post_assay <- read.csv("./Data/Personality/Post-assay.csv")

# making a column with a factor where the four levels correspond to the four phases
Personality$phase <-  factor(Personality$Time, levels = c("6-9", "13-16", "20-23", "27-30")) 

# making a list where each level of the list is a different phase
phases <- split(Personality, Personality$phase)

# function to apply to the four phases: 1, 2, 3, and 4
func_phase <- function(phase = 1){
    df <- phases[[phase]] # getting phase dataframe based on index (1-4)
    df$Behaviour <- df[,paste0("Phase",phase)] # getting columns that says which behaviour was in that phase
    df <- df[,!(names(df) %in% paste0("Phase", 1:4))] # removing the now-redundant Phase1,...,Phase4 columns
    return(df) # return dataframe
}

# applying function, returning a list of four dataframes
Personality_list <- lapply(1:4, function(x) func_phase(x))
Personality_df <- dplyr::bind_rows(Personality_list) # stakes dataframe on top of each other

# making an ID for the tank info (four phases in a session)
Personality_df <- Personality_df %>% dplyr::mutate(fish_session_ID = paste(Fish_ID, Date, Session, Camera)) %>% dplyr::arrange(fish_session_ID) 

# turning from wide to long
vars <- c("tot_dist", "mean_speed", "mean_dist_05",  
          "tot_dist_05", "freeze_dur", "zone_510_dur",  
          "zone_05_dur",  "zone_2025_dur","zone_1520_dur", 
          "zone_3035_dur", "zone_1015_dur", "zone_3540_dur", 
          "zone_2530_dur", "zone_near_dur", "zone_middle_dur", 
          "zone_far_dur",  "arena_dur",  "moving_dur")
info <- c("Time", "Day", "Date",  "Arena",   "Sex", "Mark", "Session", "Camera",  "Group",  "Fish_ID", "Notes")

# four behaviours
behavs <- c("Aggression", "Novel", "Predator", "Social")

# function to rename variables for each behaviour
func_variable_behav <- function(behav = behavs[1]){
    behav_vars <- Personality_df[Personality_df$Behaviour == behav,vars] # getting just the variables for that behaviour
    names(behav_vars) <- paste(names(behav_vars), behav, sep = "_") # renaming variables so they say which behaviour they relate to
    return(behav_vars)
}
# applying function to each behaviour
vars_behavs_list <- lapply(behavs, function(x) func_variable_behav(x))
# putting the four behaviour columns next to each other
vars_behavs <- dplyr::bind_cols(vars_behavs_list) 

# adding info
Personality_wide <- cbind(Personality_df[Personality_df$Behaviour == "Aggression", info], vars_behavs)


### Adding in activity data (post-assay) to Personality_wide

Personality_wide <- dplyr::left_join(Post_assay, Personality_wide)

# five behaviours
behavs <- c("Aggression", "Novel", "Predator", "Social", "Activity") 
```





#Function for Bivar Models and Dataframe

```{r}
#Function for running the bivar model 



bivar_model <- function(var1,var2, df = Personality_wide){
  df$response1 <- df[,var1]
  df$response2 <- df[,var2]
formula1 <- bf(response1 ~ Group*Sex + (1 | 2 |Fish_ID))
formula2 <- bf(response2 ~ Group*Sex + (1 | 2 |Fish_ID))
bivar_formula <- mvbrmsformula(formula1, formula2)
bivar <- brm(formula = bivar_formula,
                     data = df,
                     family = gaussian(),
                     chains = 4,
                     iter = 6000, warmup = 2000)
return(bivar)
}





# formula1 <- bf(zone_05_dur_Social ~ Group*Sex + (1 | 2 |Fish_ID))
# formula2 <- bf(zone_05_dur_Predator ~ Group*Sex + (1 | 2 |Fish_ID))
# bivar_formula <- mvbrmsformula(formula1, formula2)
# example_Social_Predator <- brm(formula = bivar_formula,
#                      data = Personality_wide,
#                      family = gaussian(),
#                      chains = 1,#note this is just a test model that we need to run fast, real should have more chains
#                      iter = 2000, warmup = 1000)#and more iterations and more warmup
# save(example_Social_Predator, file = "./Models/example_bivar.Rdata")

load("./Models/example_bivar.Rdata")




Combinations <- combn(behav_vars,2) # To see the combinations required for the bivariate models


# Combinations required for bivar models

# Social Predator
# Social Novel
# Social Aggression
# Social Activity
# Aggression Novel
# Aggression Predator
# Aggression Activity
# Novel Predator
# Novel Activity
# Predator Activity
```
#Bivariate models and dataframes

```{r}

#Social Predator Bivariate Model

example_Social_Predator <- bivar_model("zone_05_dur_Social", "zone_05_dur_Predator")
save(example_Social_Predator, file = "./Models/social_predator_bivar.Rdata")


social_predator_bivar <- bivar_brm_func("example_Social_Predator")

#Social_Novel Bivariate model

example_Social_Novel <- bivar_model("zone_05_dur_Social", "zone_05_dur_Novel")
save(example_Social_Novel, file = "./Models/social_novel_bivar.Rdata")


social_novel_bivar <- bivar_brm_func("example_Social_Novel")


#Social_Aggression Bivariate model

example_Social_Aggression <- bivar_model("zone_05_dur_Social", "zone_05_dur_Aggression")
save(example_Social_Aggression, file = "./Models/social_aggression_bivar.Rdata")


social_aggression_bivar <- bivar_brm_func("example_Social_Aggression")




#Social_Activity Bivariate Model

example_Social_Activity <- bivar_model("zone_05_dur_Social", "tot_dist_Activity")
save(example_Social_Activity, file = "./Models/social_activity_bivar.Rdata")


social_activity_bivar <- bivar_brm_func("example_Social_Activity")


#Agression Novel Bivariate Model

example_Aggression_Novel <- bivar_model("zone_05_dur_Aggression", "zone_05_dur_Novel")
save(example_Aggression_Novel, file = "./Models/aggression_novel_bivar.Rdata")


aggression_novel_bivar <- bivar_brm_func("example_Aggression_Novel")

#Agression Predator Bivariate Model

example_Aggression_Predator <- bivar_model("zone_05_dur_Aggression", "zone_05_dur_Predator")
save(example_Aggression_Predator, file = "./Models/aggression_predator_bivar.Rdata")


aggression_predator_bivar <- bivar_brm_func("example_Aggression_Predator")


#Aggression Activity Bivariate Model

example_Aggression_Activity <- bivar_model("zone_05_dur_Aggression", "tot_dist_Activity")
save(example_Aggression_Activity, file = "./Models/aggression_activity_bivar.Rdata")

aggression_activity_bivar <- bivar_brm_func("example_Aggression_Activity")


#Novel Predator Bivariate Model

example_Novel_Predator <- bivar_model("zone_05_dur_Novel", "zone_05_dur_Predator")
save(example_Novel_Predator, file = "./Models/novel_predator_bivar.Rdata")


novel_predator_bivar <- bivar_brm_func("example_Novel_Predator")



#Novel Activity Bivariate Model

example_Novel_Activity <- bivar_model("zone_05_dur_Novel", "tot_dist_Activity")
save(example_Novel_Activity, file = "./Models/novel_activity_bivar.Rdata")

novel_activity_bivar <- bivar_brm_func("example_Novel_Activity")


#Predator Activity Bivariate Model

example_Predator_Activity <- bivar_model("zone_05_dur_Predator", "tot_dist_Activity")
save(example_Predator_Activity, file = "./Models/predator_activity_bivar.Rdata")

predator_activity_bivar <- bivar_brm_func("example_Predator_Activity")


```




#Loading bivar models

```{r}
load("./Models/aggression_activity_bivar.Rdata")
load("./Models/aggression_novel_bivar.Rdata")
load("./Models/aggression_predator_bivar.Rdata")
load("./Models/novel_activity_bivar.Rdata")
load("./Models/novel_predator_bivar.Rdata")
load("./Models/predator_activity_bivar.Rdata")
load("./Models/social_activity_bivar.Rdata")
load("./Models/social_aggression_bivar.Rdata")
load("./Models/social_novel_bivar.Rdata")
load("./Models/social_predator_bivar.Rdata")



bivar_models_names <- c("example_Aggression_Activity",
"example_Aggression_Novel",
"example_Aggression_Predator",
"example_Novel_Activity",
"example_Novel_Predator",
"example_Predator_Activity",
"example_Social_Activity",
"example_Social_Aggression",
"example_Social_Novel",
"example_Social_Predator")

bivar_brm_func <- function(mod_char){
mod <- get(mod_char)
post <- as.data.frame(mod)
# getting names of behav1 and behav2
# use stringr::str_split for this
inter_key <- stringr::str_split(mod_char, "_")[[1]] 


behaviour1 <- inter_key[2]
behaviour2 <- inter_key[3]
behav1 <- "response1"
behav2 <- "response2"

#Changed to be able to use it with function for bivar models, however this may need tweaking as response1 and response2 won't be great to work with in future functions for plotting for example

# understand the parameters in the bivariate model:
names(post)
#what do we want to get?
#y = B0 + fish_ID + B1*treatment + B2*male+ B3*treatment*male 
cols <- names(post)
cols


B0_1 <- post[,stringr::str_detect(cols, behav1)  & stringr::str_detect(cols, "Intercept") & ! stringr::str_detect(cols,"Fish")] 
B1_1 <- post[,stringr::str_detect(cols, behav1)  & stringr::str_detect(cols, "GroupTreatment") & ! stringr::str_detect(cols,"Fish") & ! stringr::str_detect(cols, "Sex")] 
B2_1 <- post[,stringr::str_detect(cols, behav1)  & stringr::str_detect(cols, "Sex") & ! stringr::str_detect(cols,"Fish") & ! stringr::str_detect(cols, "GroupTreatment")] 
B3_1 <- post[,stringr::str_detect(cols, behav1)  & stringr::str_detect(cols, "Sex") & ! stringr::str_detect(cols,"Fish") & stringr::str_detect(cols, "GroupTreatment")]
B0_2 <- post[,stringr::str_detect(cols, behav2)  & stringr::str_detect(cols, "Intercept") & ! stringr::str_detect(cols,"Fish")] 
B1_2 <- post[,stringr::str_detect(cols, behav2)  & stringr::str_detect(cols, "GroupTreatment") & ! stringr::str_detect(cols,"Fish") & ! stringr::str_detect(cols, "Sex")] 
B2_2 <- post[,stringr::str_detect(cols, behav2)  & stringr::str_detect(cols, "Sex") & ! stringr::str_detect(cols,"Fish") & ! stringr::str_detect(cols, "GroupTreatment")] 
B3_2 <- post[,stringr::str_detect(cols, behav2)  & stringr::str_detect(cols, "Sex") & ! stringr::str_detect(cols,"Fish") & stringr::str_detect(cols, "GroupTreatment")]
sigma_ID1 <- post[,stringr::str_detect(cols, behav1)  & stringr::str_detect(cols, "sd_Fish")]
sigma_ID2 <- post[,stringr::str_detect(cols, behav2)  & stringr::str_detect(cols, "sd_Fish")]
cor_ID1_ID2 <- post[,stringr::str_detect(cols, behav1)  & stringr::str_detect(cols, behav2) & stringr::str_detect(cols, "cor_Fish")]
sigma_e1 <- post[,stringr::str_detect(cols, behav1) & stringr::str_detect(cols, "sigma_")]
sigma_e2 <- post[,stringr::str_detect(cols, behav2) & stringr::str_detect(cols, "sigma_")]
cor_e1_e2 <- post[,stringr::str_detect(cols, behav1) & stringr::str_detect(cols, behav2) & stringr::str_detect(cols, "rescor_")]
tot_var1 <- sigma_ID1 + sigma_e1
tot_var2 <- sigma_ID2 + sigma_e2
rpt1 <- sigma_ID1/tot_var1
rpt2 <- sigma_ID2/tot_var2


df <- data.frame(behaviour1,behaviour2, B0_1, B1_1, B2_1, B3_1, B0_2,B1_2,B2_2,B3_2,sigma_ID1,sigma_ID2,cor_ID1_ID2,sigma_e1,sigma_e2,cor_e1_e2,rpt1,rpt2)
return(df)
}

bivar_processed <- lapply(bivar_models_names, function(x) bivar_brm_func(x))

bivar_combined <- dplyr::bind_rows(bivar_processed)
```

#Function for population parameters

```{r}
#y = B0 + fish_ID + B1*treatment + B2*male+ B3*treatment*male 


func_pop_bivar <- function(behav = "Aggression", mod_processed = bivar_combined){
mod <- mod_processed %>% dplyr::mutate(B0 = dplyr::case_when(behaviour1 == behav ~ B0_1,
                                                behaviour2 == behav ~ B0_2 ),
                                 B1 = dplyr::case_when(behaviour1 == behav ~ B1_1,
                                                behaviour2 == behav ~ B1_2),
                                 B2 = dplyr::case_when(behaviour1 == behav ~ B2_1,
                                                behaviour2 == behav ~ B2_2),
                                 B3 = dplyr::case_when(behaviour1 == behav ~ B3_1,
                                                behaviour2 == behav ~ B3_2),
                                 sigma_ID = dplyr::case_when(behaviour1 == behav ~ sigma_ID1,
                                                behaviour2 == behav ~ sigma_ID2),
                                 sigma_e = dplyr::case_when(behaviour1 == behav ~ sigma_e1,
                                                behaviour2 == behav ~ sigma_e2),
                                 rpt = dplyr::case_when(behaviour1 == behav ~ rpt1,
                                                behaviour2 == behav ~ rpt2)) %>%
  dplyr::filter(!is.na(B0))
  
    control_female <- mod$B0
    treatment_female_minus_control_female <- mod$B1 
    treatment_female <- mod$B1 + control_female
    control_male_minus_control_female <- mod$B2
    control_male <- mod$B2 + control_female
    treatment_male <- mod$B0 + mod$B1 + mod$B2 + mod$B3
    treatment_male_minus_treatment_female <- treatment_male - treatment_female
    treatment_male_minus_control_male <- treatment_male - control_male
    
  
    
df_pop <- data.frame (control_female,treatment_female,treatment_female_minus_control_female,control_male,treatment_male,control_male_minus_control_female,treatment_male_minus_control_male, treatment_male_minus_treatment_female)



str(df_pop)
data <- cbind(
    apply(df_pop,2,function(x) mean(x)),
    apply(df_pop, 2, function(x) quantile(x, 0.025)),
    apply(df_pop, 2, function(x) quantile(x, 0.975))
) %>% as.data.frame()

names(data) <- c("mean.post", "ci.lb", "ci.ub")
data$coef <- (row.names(data))
data$behavior <- behav
data$coef <- factor(data$coef, levels = c("control_female", "treatment_female", "control_male", "treatment_male","treatment_female_minus_control_female", "treatment_male_minus_control_male", "control_male_minus_control_female", "treatment_male_minus_treatment_female"))


    
   return(data)
}

behaviors <- c("Activity", "Novel", "Social", "Predator", "Aggression")

bivar_behavs_results <- dplyr::bind_rows(lapply(behaviors, function(x) func_pop_bivar(x)))

```





#Comparing Control and Treatment groups 

To do this, we want to subset by control and treatment groups and then run the 2x10 models again without "group" as a fixed effect

we looked for a treatment effect in BETWEEN-INDIVIDUAL CORRELATION  (between traits)

and we looked for a treatment effect in repeatability (within traits)

$$y_{ij} = \beta_0 + \text{ID}_j + \beta_1(\text{male})+ e_i$$


```{r}
#Subsetting data into control and treatment 

Personality_wide_control <- subset(Personality_wide, Personality_wide$Group == "Control")
Personality_wide_treatment <- subset(Personality_wide, Personality_wide$Group == "Treatment")




#Functions for control and treatment bivariate models
bivar_model_control <- function(var1,var2, df = Personality_wide_control){
  df$response1 <- df[,var1]
  df$response2 <- df[,var2]
formula1 <- bf(response1 ~ Sex + (1 | 2 |Fish_ID))
formula2 <- bf(response2 ~ Sex + (1 | 2 |Fish_ID))
bivar_formula <- mvbrmsformula(formula1, formula2)
bivar <- brm(formula = bivar_formula,
                     data = df,
                     family = gaussian(),
                     chains = 4,
                     iter = 6000, warmup = 2000)
return(bivar)
}

bivar_model_treatment <- function(var1,var2, df = Personality_wide_treatment){
  df$response1 <- df[,var1]
  df$response2 <- df[,var2]
formula1 <- bf(response1 ~ Sex + (1 | 2 |Fish_ID))
formula2 <- bf(response2 ~ Sex + (1 | 2 |Fish_ID))
bivar_formula <- mvbrmsformula(formula1, formula2)
bivar <- brm(formula = bivar_formula,
                     data = df,
                     family = gaussian(),
                     chains = 4,
                     iter = 6000, warmup = 2000)
return(bivar)
}






bivar_processed <- lapply(bivar_models_names, function(x) bivar_brm_func(x))

bivar_combined <- dplyr::bind_rows(bivar_processed)
```

#Bivariate models CONTROL

```{r}

#Social Predator Bivariate Model

example_Social_Predator_control <- bivar_model_control("zone_05_dur_Social", "zone_05_dur_Predator")
save(example_Social_Predator_control, file = "./Models/social_predator_bivar_control.Rdata")


#Social_Novel Bivariate model

example_Social_Novel_control <- bivar_model_control("zone_05_dur_Social", "zone_05_dur_Novel")
save(example_Social_Novel_control, file = "./Models/social_novel_bivar_control.Rdata")



#Social_Aggression Bivariate model

example_Social_Aggression_control <- bivar_model_control("zone_05_dur_Social", "zone_05_dur_Aggression")
save(example_Social_Aggression_control, file = "./Models/social_aggression_bivar_control.Rdata")


#Social_Activity Bivariate Model

example_Social_Activity_control <- bivar_model_control("zone_05_dur_Social", "tot_dist_Activity")
save(example_Social_Activity_control, file = "./Models/social_activity_bivar_control.Rdata")


#Agression Novel Bivariate Model

example_Aggression_Novel_control <- bivar_model_control("zone_05_dur_Aggression", "zone_05_dur_Novel")
save(example_Aggression_Novel_control, file = "./Models/aggression_novel_bivar_control.Rdata")


#Agression Predator Bivariate Model

example_Aggression_Predator_control <- bivar_model_control("zone_05_dur_Aggression", "zone_05_dur_Predator")
save(example_Aggression_Predator_control, file = "./Models/aggression_predator_bivar_control.Rdata")


#Aggression Activity Bivariate Model

example_Aggression_Activity_control <- bivar_model_control("zone_05_dur_Aggression", "tot_dist_Activity")
save(example_Aggression_Activity_control, file = "./Models/aggression_activity_bivar_control.Rdata")



#Novel Predator Bivariate Model

example_Novel_Predator_control <- bivar_model_control("zone_05_dur_Novel", "zone_05_dur_Predator")
save(example_Novel_Predator_control, file = "../Models/novel_predator_bivar_control.Rdata")

#Novel Activity Bivariate Model

example_Novel_Activity_control <- bivar_model_control("zone_05_dur_Novel", "tot_dist_Activity")
save(example_Novel_Activity_control, file = "./Models/novel_activity_bivar_control.Rdata")


#Predator Activity Bivariate Model

example_Predator_Activity_control <- bivar_model_control("zone_05_dur_Predator", "tot_dist_Activity")
save(example_Predator_Activity_control, file = "./Models/predator_activity_bivar_control.Rdata")
```

#Loading models and creating new functions CONTROL
```{r}
load("./Models/aggression_activity_bivar_control.Rdata")
load("./Models/aggression_novel_bivar_control.Rdata")
load("./Models/aggression_predator_bivar_control.Rdata")
load("./Models/novel_activity_bivar_control.Rdata")
load("./Models/novel_predator_bivar_control.Rdata")
load("./Models/predator_activity_bivar_control.Rdata")
load("./Models/social_activity_bivar_control.Rdata")
load("./Models/social_aggression_bivar_control.Rdata")
load("./Models/social_novel_bivar_control.Rdata")
load("./Models/social_predator_bivar_control.Rdata")


#Vector of model names to be able to use with lapply
bivar_models_names_control <- c("example_Aggression_Activity_control",
"example_Aggression_Novel_control",
"example_Aggression_Predator_control",
"example_Novel_Activity_control",
"example_Novel_Predator_control",
"example_Predator_Activity_control",
"example_Social_Activity_control",
"example_Social_Aggression_control",
"example_Social_Novel_control",
"example_Social_Predator_control")




#Applying brm_func
bivar_processed_control <- lapply(bivar_models_names_control, function(x) bivar_brm_func(x))

bivar_combined_control <- dplyr::bind_rows(bivar_processed_control)

#Population parameters 



func_pop_bivar_control <- function(behav = "Aggression", mod_processed = bivar_combined_control){
mod <- mod_processed %>% dplyr::mutate(B0 = dplyr::case_when(behaviour1 == behav ~ B0_1,
                                                behaviour2 == behav ~ B0_2 ),
                                B2 = dplyr::case_when(behaviour1 == behav ~ B2_1,
                                                behaviour2 == behav ~ B2_2),
                                 sigma_ID = dplyr::case_when(behaviour1 == behav ~ sigma_ID1,
                                                behaviour2 == behav ~ sigma_ID2),
                                 sigma_e = dplyr::case_when(behaviour1 == behav ~ sigma_e1,
                                                behaviour2 == behav ~ sigma_e2),
                                 rpt = dplyr::case_when(behaviour1 == behav ~ rpt1,
                                                behaviour2 == behav ~ rpt2)) %>%
  dplyr::filter(!is.na(B0))
  
    control_female <- mod$B0
    control_male_minus_control_female <- mod$B2
    control_male <- mod$B2 + control_female

    
  
    
df_pop <- data.frame (control_female,control_male,control_male_minus_control_female)



str(df_pop)
data <- cbind(
    apply(df_pop,2,function(x) mean(x)),
    apply(df_pop, 2, function(x) quantile(x, 0.025)),
    apply(df_pop, 2, function(x) quantile(x, 0.975))
) %>% as.data.frame()

names(data) <- c("mean.post", "ci.lb", "ci.ub")
data$coef <- (row.names(data))
data$behavior <- behav
data$coef <- factor(data$coef, levels = c("control_female", "control_male",  "control_male_minus_control_female"))


    
   return(data)
}

behaviors <- c("Activity", "Novel", "Social", "Predator", "Aggression")

bivar_behavs_results_control <- dplyr::bind_rows(lapply(behaviors, function(x) func_pop_bivar_control(x)))



#Plots

bivar_combined_control$behav_syndrome <- paste0(bivar_combined_control$behaviour1, " vs. ", bivar_combined_control$behaviour2)
ggplot(bivar_combined_control) + theme_classic() +
  geom_density(aes(cor_ID1_ID2)) +
  geom_vline(xintercept = 0) +
  facet_wrap(~behav_syndrome)

```

#Bivariate models TREATMENT

```{r}
#Social Predator Bivariate Model

example_Social_Predator_treatment <- bivar_model_treatment("zone_05_dur_Social", "zone_05_dur_Predator")
save(example_Social_Predator_treatment, file = "./Models/social_predator_bivar_treatment.Rdata")


#Social_Novel Bivariate model

example_Social_Novel_treatment <- bivar_model_treatment("zone_05_dur_Social", "zone_05_dur_Novel")
save(example_Social_Novel_treatment, file = "./Models/social_novel_bivar_treatment.Rdata")



#Social_Aggression Bivariate model

example_Social_Aggression_treatment <- bivar_model_treatment("zone_05_dur_Social", "zone_05_dur_Aggression")
save(example_Social_Aggression_treatment, file = "./Models/social_aggression_bivar_treatment.Rdata")


#Social_Activity Bivariate Model

example_Social_Activity_treatment <- bivar_model_treatment("zone_05_dur_Social", "tot_dist_Activity")
save(example_Social_Activity_treatment, file = "./Models/social_activity_bivar_treatment.Rdata")


#Agression Novel Bivariate Model

example_Aggression_Novel_treatment <- bivar_model_treatment("zone_05_dur_Aggression", "zone_05_dur_Novel")
save(example_Aggression_Novel_treatment, file = "./Models/aggression_novel_bivar_treatment.Rdata")


#Agression Predator Bivariate Model

example_Aggression_Predator_treatment <- bivar_model_treatment("zone_05_dur_Aggression", "zone_05_dur_Predator")
save(example_Aggression_Predator_treatment, file = "./Models/aggression_predator_bivar_treatment.Rdata")


#Aggression Activity Bivariate Model

example_Aggression_Activity_treatment <- bivar_model_treatment("zone_05_dur_Aggression", "tot_dist_Activity")
save(example_Aggression_Activity_treatment, file = "./Models/aggression_activity_bivar_treatment.Rdata")



#Novel Predator Bivariate Model

example_Novel_Predator_treatment <- bivar_model_treatment("zone_05_dur_Novel", "zone_05_dur_Predator")
save(example_Novel_Predator_treatment, file = "./Models/novel_predator_bivar_treatment.Rdata")

#Novel Activity Bivariate Model

example_Novel_Activity_treatment <- bivar_model_treatment("zone_05_dur_Novel", "tot_dist_Activity")
save(example_Novel_Activity_treatment, file = "./Models/novel_activity_bivar_treatment.Rdata")


#Predator Activity Bivariate Model

example_Predator_Activity_treatment <- bivar_model_treatment("zone_05_dur_Predator", "tot_dist_Activity")
save(example_Predator_Activity_treatment, file = "./Models/predator_activity_bivar_treatment.Rdata")
```

#Loading models and creating new functions TREATMENT
```{r}
load("./Models/aggression_activity_bivar_treatment.Rdata")
load("./Models/aggression_novel_bivar_treatment.Rdata")
load("./Models/aggression_predator_bivar_treatment.Rdata")
load("./Models/novel_activity_bivar_treatment.Rdata")
load("./Models/novel_predator_bivar_treatment.Rdata")
load("./Models/predator_activity_bivar_treatment.Rdata")
load("./Models/social_activity_bivar_treatment.Rdata")
load("./Models/social_aggression_bivar_treatment.Rdata")
load("./Models/social_novel_bivar_treatment.Rdata")
load("./Models/social_predator_bivar_treatment.Rdata")


#Vector of model names to be able to use with lapply
bivar_models_names_treatment <- c("example_Aggression_Activity_treatment",
"example_Aggression_Novel_treatment",
"example_Aggression_Predator_treatment",
"example_Novel_Activity_treatment",
"example_Novel_Predator_treatment",
"example_Predator_Activity_treatment",
"example_Social_Activity_treatment",
"example_Social_Aggression_treatment",
"example_Social_Novel_treatment",
"example_Social_Predator_treatment")


#Applying brm_func
bivar_processed_treatment <- lapply(bivar_models_names_treatment, function(x) bivar_brm_func(x))

bivar_combined_treatment <- dplyr::bind_rows(bivar_processed_treatment)

#Population parameters 



func_pop_bivar_treatment <- function(behav = "Aggression", mod_processed = bivar_combined_treatment){
mod <- mod_processed %>% dplyr::mutate(B0 = dplyr::case_when(behaviour1 == behav ~ B0_1,
                                                behaviour2 == behav ~ B0_2 ),
                                B2 = dplyr::case_when(behaviour1 == behav ~ B2_1,
                                                behaviour2 == behav ~ B2_2),
                                 sigma_ID = dplyr::case_when(behaviour1 == behav ~ sigma_ID1,
                                                behaviour2 == behav ~ sigma_ID2),
                                 sigma_e = dplyr::case_when(behaviour1 == behav ~ sigma_e1,
                                                behaviour2 == behav ~ sigma_e2),
                                 rpt = dplyr::case_when(behaviour1 == behav ~ rpt1,
                                                behaviour2 == behav ~ rpt2)) %>%
  dplyr::filter(!is.na(B0))
  
    treatment_female <- mod$B0
    treatment_male_minus_treatment_female <- mod$B2
    treatment_male <- mod$B2 + treatment_female

    
  
    
df_pop <- data.frame (treatment_female,treatment_male,treatment_male_minus_treatment_female)



str(df_pop)
data <- cbind(
    apply(df_pop,2,function(x) mean(x)),
    apply(df_pop, 2, function(x) quantile(x, 0.025)),
    apply(df_pop, 2, function(x) quantile(x, 0.975))
) %>% as.data.frame()

names(data) <- c("mean.post", "ci.lb", "ci.ub")
data$coef <- (row.names(data))
data$behavior <- behav
data$coef <- factor(data$coef, levels = c("treatment_female", "treatment_male",  "treatment_male_minus_treatment_female"))


    
   return(data)
}

behaviors <- c("Activity", "Novel", "Social", "Predator", "Aggression")

bivar_behavs_results_treatment <- dplyr::bind_rows(lapply(behaviors, function(x) func_pop_bivar_treatment(x)))
#It seemed to work although am not sure this is correct, please double check!

#Density plots

bivar_combined_treatment$behav_syndrome <- paste0(bivar_combined_treatment$behaviour1, " vs. ", bivar_combined_treatment$behaviour2)
ggplot(bivar_combined_treatment) + theme_classic() +
  geom_density(aes(cor_ID1_ID2)) +
  geom_vline(xintercept = 0) +
  facet_wrap(~behav_syndrome)
```


#Contrast Analysis and plot

```{r}

#Rename columns

colnames(bivar_combined_control) <- c("behaviour1_control", "behaviour2_control","B0_1_control","B2_1_control","B0_2_control", "B2_2_control", "sigma_ID1_control", "sigma_ID2_control","cor_ID1_ID2_control","sigma_e1_control","sigma_e2_control","cor_e1_e2_control","rpt1_control","rpt2_control",          
"behav_syndrome_control")

colnames(bivar_combined_treatment) <- c("behaviour1_treatment", "behaviour2_treatment","B0_1_treatment","B2_1_treatment","B0_2_treatment", "B2_2_treatment", "sigma_ID1_treatment", "sigma_ID2_treatment","cor_ID1_ID2_treatment","sigma_e1_treatment","sigma_e2_treatment","cor_e1_e2_treatment","rpt1_treatment","rpt2_treatment",          
"behav_syndrome_treatment")

#Add columns together to create a new wide data frame

bivar_control_treatment <- dplyr::bind_cols(bivar_combined_control, bivar_combined_treatment)

#Checking model results same order
paste0(bivar_control_treatment$behaviour1_control, bivar_control_treatment$behaviour2_control) == paste0(bivar_control_treatment$behaviour1_treatment, bivar_control_treatment$behaviour2_treatment)

#All TRUE

#Getting treatment difference in variance components

names(bivar_control_treatment)

contrasts_var <- bivar_control_treatment %>% dplyr::mutate(sigma_ID1_treatment_minus_control=sigma_ID1_treatment-sigma_ID1_control,
                                   sigma_ID2_treatment_minus_control=sigma_ID2_treatment-sigma_ID2_control,
                                   cor_ID1_ID2_treatment_minus_control=cor_ID1_ID2_treatment-cor_ID1_ID2_control,
                                   sigma_e1_treatment_minus_control=sigma_e1_treatment-sigma_e1_control,
                                   sigma_e2_treatment_minus_control=sigma_e2_treatment-sigma_e2_control,
                                   cor_e1_e2_treatment_minus_control=cor_e1_e2_treatment-cor_e1_e2_control,
                                   rpt1_treatment_minus_control=rpt1_treatment-rpt1_control,
                                   rpt2_treatment_minus_control=rpt2_treatment-rpt2_control,
                                   mod_id=paste0(behaviour1_control, " vs ",behaviour2_control)) %>%
  dplyr::rename(behaviour1=behaviour1_control, behaviour2=behaviour2_control) %>%
  dplyr::select(behaviour1, behaviour2,mod_id,
         sigma_ID1_treatment_minus_control,
                                   sigma_ID2_treatment_minus_control,
                                   cor_ID1_ID2_treatment_minus_control,
                                   sigma_e1_treatment_minus_control,
                                   sigma_e2_treatment_minus_control,
                                   cor_e1_e2_treatment_minus_control,
                                   rpt1_treatment_minus_control,
                                   rpt2_treatment_minus_control, cor_ID1_ID2_treatment,
         cor_ID1_ID2_control)


#Contrasts behavioral syndromes

contrasts_var %>% dplyr::group_by(mod_id) %>% dplyr::summarise(behav_syn_mean = mean(cor_ID1_ID2_treatment_minus_control), cor_control = mean(cor_ID1_ID2_control),cor_treatment = mean(cor_ID1_ID2_treatment))

df <- dplyr::bind_rows(lapply(split(contrasts_var, contrasts_var$mod_id), function(x) data.frame(est=mean(x$cor_ID1_ID2_treatment_minus_control),
lower_bounds=quantile(x$cor_ID1_ID2_treatment_minus_control, 0.025),
upper_bounds=quantile(x$cor_ID1_ID2_treatment_minus_control, 0.975))))

df$mod_id <- unique(contrasts_var$mod_id)

df2 <- dplyr::bind_rows(lapply(split(contrasts_var, contrasts_var$mod_id), function(x)
  
data.frame(est=mean(x$cor_ID1_ID2_treatment),
lower_bounds=quantile(x$cor_ID1_ID2_treatment, 0.025),
upper_bounds=quantile(x$cor_ID1_ID2_treatment, 0.975))))

df2$mod_id <- unique(contrasts_var$mod_id)

df3 <- dplyr::bind_rows(lapply(split(contrasts_var, contrasts_var$mod_id), function(x)
  
data.frame(est=mean(x$cor_ID1_ID2_control),
lower_bounds=quantile(x$cor_ID1_ID2_control, 0.025),
upper_bounds=quantile(x$cor_ID1_ID2_control, 0.975))))

df3$mod_id <- unique(contrasts_var$mod_id)

df_joined <- bind_rows(df, df2, df3)

df_joined <- df_joined %>% mutate(condition = c("contrast", "contrast", "contrast", "contrast", "contrast","contrast", "contrast", "contrast", "contrast", "contrast", "treatment", "treatment","treatment", "treatment","treatment","treatment", "treatment","treatment", "treatment","treatment","control","control","control","control","control","control","control","control","control","control"))

#plots
#just for contrasts
ggplot(df) + 
geom_pointrange(aes(x = mod_id, y = est, ymin = lower_bounds, ymax = upper_bounds))+
geom_hline(yintercept=0, linetype="dotted")+
coord_flip()

#means for both control and treatment as well as contrast
behav_syndrome_personality_plot <- ggplot(df_joined, aes(x=mod_id, y=est, colour=condition)) +
geom_errorbar(aes(ymin=lower_bounds, ymax=upper_bounds), width = 0.4, position = position_dodge(0.3), size=0.8) +
geom_point(aes(x = mod_id, y = est), position = position_dodge(0.3), size=3)+
geom_hline(yintercept = 0, lty = "dotted") +
coord_flip()+
   theme(axis.title.y=element_blank())+
  theme_classic()+
  scale_color_manual(values=c("#000000", "#DD8D29", "#E2D200"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=2),axis.ticks = element_line(size=2,color="black"),axis.ticks.length=unit(0.2,"cm"))+      font("xylab",size=15)+font("xy",size=15)+font("xy.text", size = 15) +
  theme(axis.title.y=element_blank())+
   theme(legend.position = "bottom")+
    theme(legend.title=element_blank())+
  ggtitle("Behavioral Syndrome - Personality")
 
behav_syndrome_personality_plot
```

#Function and contrasts for repeatabilities contrasts
```{r}
#Function for contrasts 

func_rpt_contrasts <- function(behav = "Aggression", mod_processed = bivar_control_treatment){
mod <- mod_processed %>% dplyr::mutate(rpt_control = dplyr::case_when(behaviour1_control == behav ~ rpt1_control,
                                                behaviour2_control == behav ~ rpt2_control),
                                 rpt_treatment = dplyr::case_when(behaviour1_treatment == behav ~ rpt1_treatment,
                                                behaviour2_treatment == behav ~ rpt2_treatment))
    rpt_control <- mod$rpt_control
    rpt_treatment <- mod$rpt_treatment
    rpt_treatment_minus_rpt_control <- rpt_treatment - rpt_control # ROSE: you've already done this above

    

    
  
    
df <- data.frame(rpt_treatment_minus_rpt_control, rpt_control, rpt_treatment)



str(df)
data <- cbind(
    apply(df,2,function(x) mean(x,na.rm = TRUE)),
    apply(df, 2, function(x) quantile(x, 0.025,na.rm = TRUE)),
    apply(df, 2, function(x) quantile(x, 0.975,na.rm = TRUE))
) %>% as.data.frame()

names(data) <- c("mean.post", "ci.lb", "ci.ub")
data$coef <- (row.names(data))
data$behavior <- behav
data$coef <- factor(data$coef, levels = c("rpt_treatment_minus_rpt_control"))


    
   return(data)
}

behaviors <- c("Activity", "Novel", "Social", "Predator", "Aggression")

rpt_behav_contrasts <- dplyr::bind_rows(lapply(behaviors, function(x) func_rpt_contrasts(x)))

rpt_behav_contrasts <- rpt_behav_contrasts %>% select(-coef)

rpt_behav_contrasts <- rpt_behav_contrasts %>% mutate(condition = c("contrast", "control", "treatment","contrast", "control", "treatment","contrast", "control", "treatment","contrast", "control", "treatment","contrast", "control", "treatment"))


#plot

rpt_behavs_plot <- ggplot(rpt_behav_contrasts, aes(x=behavior, y=mean.post, colour=condition)) +
geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0.4, position = position_dodge(0.3), size=0.8) +
geom_point(aes(x = behavior, y = mean.post), position = position_dodge(0.3), size=3)+
geom_hline(yintercept = 0, lty = "dotted") +
coord_flip()+
   theme(axis.title.y=element_blank())+
  theme_classic()+
  scale_color_manual(values=c("#000000", "#DD8D29", "#E2D200"))+
    theme(panel.border = element_rect(colour = "black", fill=NA, size=2),axis.ticks = element_line(size=2,color="black"),axis.ticks.length=unit(0.2,"cm"))+      font("xylab",size=15)+font("xy",size=15)+font("xy.text", size = 15) +
  theme(axis.title.y=element_blank())+
   theme(legend.position = "bottom")+
    theme(legend.title=element_blank())+
  ggtitle("Repeatability differences between control and treatment groups")
 
rpt_behavs_plot


```
#Code for running everything at once
```{r}
#CONTROL

#Social Predator Bivariate Model

example_Social_Predator_control <- bivar_model_control("zone_05_dur_Social", "zone_05_dur_Predator")
save(example_Social_Predator_control, file = "./Models/social_predator_bivar_control.Rdata")


#Social_Novel Bivariate model

example_Social_Novel_control <- bivar_model_control("zone_05_dur_Social", "zone_05_dur_Novel")
save(example_Social_Novel_control, file = "./Models/social_novel_bivar_control.Rdata")



#Social_Aggression Bivariate model

example_Social_Aggression_control <- bivar_model_control("zone_05_dur_Social", "zone_05_dur_Aggression")
save(example_Social_Aggression_control, file = "./Models/social_aggression_bivar_control.Rdata")


#Social_Activity Bivariate Model

example_Social_Activity_control <- bivar_model_control("zone_05_dur_Social", "tot_dist_Activity")
save(example_Social_Activity_control, file = "./Models/social_activity_bivar_control.Rdata")


#Agression Novel Bivariate Model

example_Aggression_Novel_control <- bivar_model_control("zone_05_dur_Aggression", "zone_05_dur_Novel")
save(example_Aggression_Novel_control, file = "./Models/aggression_novel_bivar_control.Rdata")


#Agression Predator Bivariate Model

example_Aggression_Predator_control <- bivar_model_control("zone_05_dur_Aggression", "zone_05_dur_Predator")
save(example_Aggression_Predator_control, file = "./Models/aggression_predator_bivar_control.Rdata")


#Aggression Activity Bivariate Model

example_Aggression_Activity_control <- bivar_model_control("zone_05_dur_Aggression", "tot_dist_Activity")
save(example_Aggression_Activity_control, file = "./Models/aggression_activity_bivar_control.Rdata")



#Novel Predator Bivariate Model

example_Novel_Predator_control <- bivar_model_control("zone_05_dur_Novel", "zone_05_dur_Predator")
save(example_Novel_Predator_control, file = "./Models/novel_predator_bivar_control.Rdata")

#Novel Activity Bivariate Model

example_Novel_Activity_control <- bivar_model_control("zone_05_dur_Novel", "tot_dist_Activity")
save(example_Novel_Activity_control, file = "./Models/novel_activity_bivar_control.Rdata")


#Predator Activity Bivariate Model

example_Predator_Activity_control <- bivar_model_control("zone_05_dur_Predator", "tot_dist_Activity")
save(example_Predator_Activity_control, file = "./Models/predator_activity_bivar_control.Rdata")

#TREATMENT

#Social Predator Bivariate Model

example_Social_Predator_treatment <- bivar_model_treatment("zone_05_dur_Social", "zone_05_dur_Predator")
save(example_Social_Predator_treatment, file = "./Models/social_predator_bivar_treatment.Rdata")


#Social_Novel Bivariate model

example_Social_Novel_treatment <- bivar_model_treatment("zone_05_dur_Social", "zone_05_dur_Novel")
save(example_Social_Novel_treatment, file = "./Models/social_novel_bivar_treatment.Rdata")



#Social_Aggression Bivariate model

example_Social_Aggression_treatment <- bivar_model_treatment("zone_05_dur_Social", "zone_05_dur_Aggression")
save(example_Social_Aggression_treatment, file = "./Models/social_aggression_bivar_treatment.Rdata")


#Social_Activity Bivariate Model

example_Social_Activity_treatment <- bivar_model_treatment("zone_05_dur_Social", "tot_dist_Activity")
save(example_Social_Activity_treatment, file = "./Models/social_activity_bivar_treatment.Rdata")


#Agression Novel Bivariate Model

example_Aggression_Novel_treatment <- bivar_model_treatment("zone_05_dur_Aggression", "zone_05_dur_Novel")
save(example_Aggression_Novel_treatment, file = "./Models/aggression_novel_bivar_treatment.Rdata")


#Agression Predator Bivariate Model

example_Aggression_Predator_treatment <- bivar_model_treatment("zone_05_dur_Aggression", "zone_05_dur_Predator")
save(example_Aggression_Predator_treatment, file = "./Models/aggression_predator_bivar_treatment.Rdata")


#Aggression Activity Bivariate Model

example_Aggression_Activity_treatment <- bivar_model_treatment("zone_05_dur_Aggression", "tot_dist_Activity")
save(example_Aggression_Activity_treatment, file = "./Models/aggression_activity_bivar_treatment.Rdata")



#Novel Predator Bivariate Model

example_Novel_Predator_treatment <- bivar_model_treatment("zone_05_dur_Novel", "zone_05_dur_Predator")
save(example_Novel_Predator_treatment, file = "./Models/novel_predator_bivar_treatment.Rdata")

#Novel Activity Bivariate Model

example_Novel_Activity_treatment <- bivar_model_treatment("zone_05_dur_Novel", "tot_dist_Activity")
save(example_Novel_Activity_treatment, file = "./Models/novel_activity_bivar_treatment.Rdata")


#Predator Activity Bivariate Model

example_Predator_Activity_treatment <- bivar_model_treatment("zone_05_dur_Predator", "tot_dist_Activity")
save(example_Predator_Activity_treatment, file = "./Models/predator_activity_bivar_treatment.Rdata")
```





