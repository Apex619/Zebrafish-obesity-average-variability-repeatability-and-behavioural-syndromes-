---
title: "Big_Experiment_Analyses"
author: "Hamza"
date: "1 June 2019"
output:
  word_document: default
  html_document: default
  pdf_document: default
---

```{r,include=FALSE}
library(ggplot2)
library(lme4)
library(lmerTest)
library(sjPlot)
library(tidyverse)
library(effects)
library(Rmisc)
```

```{r, include = FALSE}
Data_Raw <- read.csv("Analysis.csv")

Data_subset = filter(Data_Raw, Tank %in% c("HA_C1","HA_C2","HA_C3", "HA_C4", "HA_T1","HA_T2","HA_T3","HA_T4"))
Data = filter(Data_subset, !Fish_ID %in% c("a6834","a6923","a7226","a7070","a7250","a7336","a7600","a7573","a7660","a6929","a6990","a7407","a7090","a7286","a7539","a6884","a7206","a7488","a6846","a7560","a7495","a7649","a7604","a7015","a7253","a7610","a7566","a7719","a7682","a7266","a7494","a7548","a7207"))

Week_0 <- subset(Data, Data$Week == "0")
```


# Boxplot 
Comparing between sexes and treatment groups over time. The treatment groups continue to gain more weight, and as expected, females are always heavier (in both groups)
```{r, echo = FALSE}
boxplot <- ggplot(data = Data) +
  geom_boxplot(mapping = aes(x = Sex, y = Weight.g., fill = Treatment_Tank)) +
  facet_grid(~Week)
  
boxplot
```  



#Summary

```{r, echo = FALSE}

Summary_Sex <- summarySE(Data, measurevar="Weight.g.", groupvars=c("Week","Treatment_Tank", "Sex"))
knitr::kable(
  Summary_Sex[1:16, ], 
  caption = "Summary_Sex"
)
```

# Line plot (body weight)

```{r, echo = FALSE}

# So error bars aren't overlapping, we can use this:
pd <- position_dodge(0.1) # move them .05 to the left and right

plot <- ggplot(Summary_Sex, aes(x=Week, y=Weight.g., colour=Treatment_Tank)) + 
  geom_errorbar(aes(ymin=Weight.g.-se, ymax=Weight.g.+se), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd)+
  labs(title = "Obesogenic vs. Control Diet",
              subtitle = "Weight change after 22 weeks") +
  facet_grid(~Sex)
  
  
  
          

plot


```

# Mixed Models with Shinichi
```{r, echo = FALSE}
Weight_Model <- lmer(Weight.g. ~ Treatment_Tank + Week + Sex + (1|Fish_ID), data=Data)
tab_model(Weight_Model)

Weight_Model <- lmer(Weight.g. ~ Treatment_Tank*Week + Sex + (1|Fish_ID), data=Data)
tab_model(Weight_Model)

Weight_Model <- lmer(Weight.g. ~ Treatment_Tank*Week + Sex*Week  + (1|Fish_ID) + (1 + Week|Tank), data=Data)
tab_model(Weight_Model)

#A significant interaction exists between treatment and week as well as sex and week. What this means is that the treatment and control tanks have a different slope and this is also dependent on the week. This is also the case for the sexes, with the females having a steeper slope, also significantly different by the week. 


Weight_Model <- lmer(Fish_Length_cm ~ Treatment_Tank*Week + Sex*Week  + (1|Fish_ID) + (1 + Week|Tank), data=Data)
tab_model(Weight_Model)

model_week0_weight <- lmer(Weight.g. ~ Treatment_Tank + Sex + Fish_Length_cm+ (1|Tank), data = Week_0 )
tab_model(model_week0_weight)

model_week0_length <- lmer(Fish_Length_cm ~ Treatment_Tank + Sex + (1|Tank), data = Week_0 )
tab_model(model_week0_length)


model_week0_bmi <- lmer(scale(BMI) ~ Treatment_Tank + Sex + (1|Tank), data = Week_0 )
tab_model(model_week0_bmi)

lm_week0 <- glm(scale(BMI) ~ Treatment_Tank + Sex , data = Week_0 )
tab_model(lm_week0)


lm_week0 <- glm(Weight.g. ~ Treatment_Tank + Sex , data = Week_0 )
tab_model(lm_week0)

lm_week0 <- glm(Fish_Length_cm ~ Treatment_Tank + Sex , data = Week_0 )
tab_model(lm_week0)

```
The results indicate the treatment is working, and as expected, females are significantly heavier. It's interesting that the control group is still gaining weight. I assume this will even out soon enough while the treatment group continues to gain weight. Every week we are seeing significant changes in weight.

#Body Length Analysis

# Individual growth

```{r, echo = FALSE} 
ggplot(Data, aes(x=Week, y=Weight.g., group = Fish_ID, colour = Treatment_Tank)) +
  geom_line() +
  facet_grid(~Sex)
```

#Summary (Body Length)

```{r, echo = FALSE}

Summary_Length_All <- summarySE(Data, measurevar="Fish_Length_cm", groupvars=c("Week","Treatment_Tank", "Sex"))
knitr::kable(
  Summary_Length_All[1:30, ], 
  caption = "Summary_Length_All"
)

Summary_Length_Treatment <- summarySE(Data, measurevar="Fish_Length_cm", groupvars=c("Week","Treatment_Tank"))
knitr::kable(
  Summary_Length_All[1:30, ], 
  caption = "Summary_Length_All"
)
```

# Line plot (fish length) for tanks

```{r, echo = FALSE}

# So error bars aren't overlapping, we can use this:
pd <- position_dodge(0.1) # move them .05 to the left and right

plot_fish_length_tanks <- ggplot(Summary_Length_All, aes(x=Week, y=Fish_Length_cm, colour=Treatment_Tank)) + 
  geom_errorbar(aes(ymin=Fish_Length_cm-se, ymax=Fish_Length_cm+se), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd)+
  labs(title = "Obesogenic vs. Control Diet",
              subtitle = "Fish lengths after 15 weeks") +
  facet_grid(~Sex)
          

plot_fish_length_tanks


```
# Line plot for treatments

```{r, echo = FALSE}

# So error bars aren't overlapping, we can use this:
pd <- position_dodge(0.1) # move them .05 to the left and right

plot_fish_length <- ggplot(Summary_Length_Treatment, aes(x=Week, y=Fish_Length_cm, colour=Treatment_Tank)) + 
  geom_errorbar(aes(ymin=Fish_Length_cm-se, ymax=Fish_Length_cm+se), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd)+
  labs(title = "Obesogenic vs. Control Diet",
              subtitle = "Fish lengths after 20 weeks") 

  
          

plot_fish_length


```
#Summary (BMI)

```{r, echo = FALSE}

Summary_BMI_Treatment <- summarySE(Data, measurevar="BMI", groupvars=c("Week","Treatment_Tank", "Sex"))
knitr::kable(
  Summary_BMI_Treatment[1:6, ], 
  caption = "Summary_BMI_Treatment"
)


```
# Column (BMI)

```{r, echo = FALSE}

# So error bars aren't overlapping, we can use this:
pd <- position_dodge(0.1) # move them .05 to the left and right

plot_bmi <- ggplot(Summary_BMI_Treatment, aes(x=Week, y=BMI, fill=Treatment_Tank)) + 
  geom_errorbar(aes(ymin=BMI-se, ymax=BMI+se), width=.1, position=pd) +
  geom_col(position=pd) +
  labs(title = "Obesogenic vs. Control Diet",
              subtitle = "Fish BMI after 12 weeks (g/cm2)")+
  facet_grid(~Sex)

          

plot_bmi

#Breeding !!! SUMMARIZE WHERE BREEDING TOOK PLACE!
```
#line plot for BMI (tanks)
```{r, echo = FALSE}

# So error bars aren't overlapping, we can use this:
pd <- position_dodge(0.1) # move them .05 to the left and right

plot_bmi_tanks <- ggplot(Summary_BMI_Treatment, aes(x=Week, y=BMI, colour=Treatment_Tank)) + 
  geom_errorbar(aes(ymin=BMI-se, ymax=BMI+se), width=.1, position=pd) +
  geom_line(position=pd) +
  geom_point(position=pd)+
  labs(title = "Obesogenic vs. Control Diet",
              subtitle = "Fish bmi after 15 weeks for tanks") +
  facet_grid(~Sex)
          

plot_bmi_tanks


```
#Scatterplot for length and weight
```{R}
Scatterplot <- ggplot(Data, aes(x=Fish_Length_cm, y=Weight.g., shape = Treatment_Tank, color = Treatment_Tank)) + 
  geom_point()+
    geom_smooth(method=lm, se=FALSE, fullrange=TRUE)+
  facet_grid(~Week)  
Scatterplot
```

```{r}
Week_0 <- subset(Data, Data$Week == "0")
```

```{r}
#Making scatterplot

Scatterplot <- ggplot(Data, aes(Week, Weight.g., colour = Treatment_Tank)) +
  geom_jitter() +
  theme_bw() +
  facet_grid(~Sex) +
  stat_smooth(method = "lm", formula = y ~ x + I(x^2), aes(fill = Treatment_Tank)) #try different formulas and compare against each other
Scatterplot

#library(devtools)
#install_github("kassambara/easyGgplot2")
library(easyGgplot2)

#Violin plot
Violin <- ggplot2.violinplot(data=Data, xName='Week',yName='Weight.g.', 
    groupName='Treatment_Tank',
    groupColors=c('#999999','#E69F00','#56B4E9'), showLegend=TRUE,
    backgroundColor="white", xtitle="Weeks", ytitle="Weight (g)", 
    mainTitle="Weight change over 20 weeks",
    addDot=FALSE, dotSize=0.3)+
  facet_grid(~Sex)

Violin

#Adding dodge, do a violin plot or beeswarm plot

```

```{r}
#Repeatability fish length

Week_0_rptr <- subset(Repeatability_Data, Repeatability_Data$Week == "0")


library(rptR)
Repeatability_Data <- read.csv("rptR_fish_length.csv")
Repeatability_Week0 <- rpt(fish_length_cm ~ Measure + Sex + Treatment_Tank + (1 | ID), grname = "ID", data = Week_0_rptr, datatype = "Gaussian", 
                     nboot = 0, npermut = 0)
Repeatability_Week0

Week_6_rptr <- subset(Repeatability_Data, Repeatability_Data$Week == "6")
Repeatability_Week6 <- rpt(fish_length_cm ~ Measure + Sex + Treatment_Tank + (1 | ID), grname = "ID", data = Week_6_rptr, datatype = "Gaussian", 
                     nboot = 0, npermut = 0)
Repeatability_Week6
```

```{r}
#Exploratory analysis

length <- ggplot(Data, aes(x=Week, y=Fish_Length_cm, group = Fish_ID, colour = Treatment_Tank)) +
  geom_line() 

length
```

#fishmethods package
```{r}
#install.packages("fishmethods")
library(fishmethods)

#Subsetting Treatment and Control Data

Treatment <- subset(Data, Data$Treatment_Tank == "Treatment")

Control <- subset(Data, Data$Treatment_Tank == "Control")



#Fitting growth curves (CONTROL)

Control_Growth_Curves <- growth(intype=1,unit=2,size=Control$Weight.g.,age=Control$Week,
        calctype=1,wgtby=1,error=1,Sinf=200,K=0.3,t0=-1)

#Fitting growth curves (TREATMENT)

Treatment_Growth_Curves <- growth(intype=1,unit=2,size=Treatment$Weight.g.,age=Treatment$Week,
        calctype=1,wgtby=1,error=1,Sinf=200,K=0.3,t0=-1)

```

#Glucose
```{r}
Glucose_Data$Sex <- as.factor(Glucose_Data$Sex)
Glucose_Data$Group <- as.factor(Glucose_Data$Group)
Glucose_Data$Meter <- as.factor(Glucose_Data$Meter)
Glucose_Model <- lmer(Glucose ~ Group + Sex + (1|Fish_ID), data=Glucose_Data)
summary(Glucose_Model)
tab_model(Glucose_Model)



Summary_Glucose <- summarySE(Glucose_Data, measurevar="Glucose", groupvars=c("Group","Sex"))
knitr::kable(
  Summary_Glucose[1:16, ], 
  caption = "Summary_Glucose"
)


```







